#!/usr/bin/expect -f

set timeout 30
set ip "72.61.224.90"
set user "root"
set password "BPtools@54321"
set openrouter_key "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"
set app_dir "mdrpedia"

spawn ssh -o StrictHostKeyChecking=no $user@$ip

expect {
    "password:" {
        send "$password\r"
    }
}

expect "#"
send "cd $app_dir\r"
expect "#"

# Pull latest changes (script update)
send "git pull\r"
expect "#"

# Update .env with OpenRouter key
# Use sed to replace if exists, or append
send "grep -q 'OPENROUTER_API_KEY' .env && sed -i 's/^OPENROUTER_API_KEY=.*/OPENROUTER_API_KEY=\"$openrouter_key\"/' .env || echo 'OPENROUTER_API_KEY=\"$openrouter_key\"' >> .env\r"
expect "#"

# Verify .env update
send "grep 'OPENROUTER_API_KEY' .env\r"
expect "#"

# Run content generator in background
send "nohup npx tsx scripts/generate-detailed-content.ts > content_generation.log 2>&1 &\r"
expect "#"

# Verify it's running
sleep 2
send "ps aux | grep generate-detailed-content | grep -v grep\r"
expect "#"

send "exit\r"
expect eof
