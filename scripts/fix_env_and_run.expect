#!/usr/bin/expect -f

set timeout 30
set ip "72.61.224.90"
set user "root"
set password "BPtools@54321"
set openrouter_key "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"

spawn ssh -o StrictHostKeyChecking=no $user@$ip

expect {
    "password:" {
        send "$password\r"
    }
}

expect "#"
send "cd mdrpedia\r"
expect "#"

# Clean up .env and add key properly with a newline
send "sed -i '/OPENROUTER_API_KEY/d' .env\r"
expect "#"
send "echo '' >> .env\r"
expect "#"
send "echo 'OPENROUTER_API_KEY=\"$openrouter_key\"' >> .env\r"
expect "#"

# Run content generator using a shell that sources .env if possible, or just pass env explicitly
# tsx doesn't load .env by default. We can use -r dotenv/config but we'd need to install it.
# Easier way: source the file in the shell before running
send "nohup sh -c 'export \$(grep -v \"^#\" .env | xargs) && npx tsx scripts/generate-detailed-content.ts' > content_generation.log 2>&1 &\r"
expect "#"

# Verify it's running
sleep 2
send "ps aux | grep generate-detailed-content | grep -v grep\r"
expect "#"

send "exit\r"
expect eof
