---
/**
 * MDRPedia - Individual Clinical Trial Page
 * Display detailed information about a specific clinical trial
 */
export const prerender = true;

import Layout from "../../layouts/Layout.astro";
import trialsData from "../../content/trials/index.json";

// Generate static paths for all trials
export function getStaticPaths() {
    const paths: { params: { id: string }; props: { trial: any; company: any; category: any } }[] = [];

    trialsData.companies.forEach((company: any) => {
        company.trials.forEach((trial: any) => {
            const category = trialsData.categories.find((c: any) => c.id === trial.category);
            paths.push({
                params: { id: trial.id },
                props: { trial, company, category }
            });
        });
    });

    return paths;
}

const { id } = Astro.params;
const { trial, company, category } = Astro.props;

// Format date helper
function formatDate(dateStr: string): string {
    if (!dateStr) return 'TBD';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
}

// Get status color
function getStatusColor(status: string): string {
    switch (status.toLowerCase()) {
        case 'active': return '#10b981';
        case 'completed': return '#3b82f6';
        case 'recruiting': return '#f59e0b';
        case 'suspended': return '#ef4444';
        default: return '#94a3b8';
    }
}

// Get phase color
function getPhaseColor(phase: string): string {
    if (phase.includes('4') || phase.includes('Post')) return '#8b5cf6';
    if (phase.includes('3')) return '#10b981';
    if (phase.includes('2')) return '#3b82f6';
    if (phase.includes('1')) return '#f59e0b';
    return '#94a3b8';
}
---

<Layout title={`${trial.name} - Clinical Trial | MDRPedia`} description={trial.description}>
    <div class="trial-page">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="/clinical-trials">Clinical Trials</a>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
                <a href={`/clinical-trials#${company.id}`}>{company.name}</a>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
                <span>{trial.id.toUpperCase()}</span>
            </nav>

            <!-- Trial Header -->
            <header class="trial-header">
                <div class="trial-meta">
                    <span class="phase-badge" style={`--phase-color: ${getPhaseColor(trial.phase)}`}>
                        {trial.phase}
                    </span>
                    <span class="status-badge" style={`--status-color: ${getStatusColor(trial.status)}`}>
                        {trial.status}
                    </span>
                    {category && (
                        <span class="category-badge">{category.name}</span>
                    )}
                </div>
                <h1>{trial.name}</h1>
                <p class="indication">{trial.indication}</p>

                <div class="sponsor">
                    <img src={company.logo} alt={company.name} class="sponsor-logo" />
                    <div class="sponsor-info">
                        <span class="sponsor-label">Sponsor</span>
                        <span class="sponsor-name">{company.name}</span>
                    </div>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span class="stat-value">{trial.enrollment?.toLocaleString() || 'N/A'}</span>
                    <span class="stat-label">Enrollment Target</span>
                </div>
                <div class="stat-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <path d="M3 21h18M5 21V7l7-4 7 4v14"/>
                        <path d="M9 21v-6h6v6"/>
                    </svg>
                    <span class="stat-value">{trial.sites || 'N/A'}</span>
                    <span class="stat-label">Trial Sites</span>
                </div>
                <div class="stat-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span class="stat-value">{trial.countries?.length || 0}</span>
                    <span class="stat-label">Countries</span>
                </div>
                <div class="stat-card">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span class="stat-value">{formatDate(trial.estimatedCompletion)}</span>
                    <span class="stat-label">Est. Completion</span>
                </div>
            </div>

            <div class="content-grid">
                <!-- Main Content -->
                <main class="main-content">
                    <!-- Description -->
                    <section class="content-section">
                        <h2>About This Trial</h2>
                        <p>{trial.description}</p>
                    </section>

                    <!-- Primary Endpoints -->
                    {trial.primaryEndpoints && trial.primaryEndpoints.length > 0 && (
                        <section class="content-section">
                            <h2>Primary Endpoints</h2>
                            <ul class="endpoints-list">
                                {trial.primaryEndpoints.map((endpoint: string) => (
                                    <li>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                        </svg>
                                        {endpoint}
                                    </li>
                                ))}
                            </ul>
                        </section>
                    )}

                    <!-- Latest Update -->
                    {trial.latestUpdate && (
                        <section class="content-section update-section">
                            <h2>Latest Update</h2>
                            <div class="update-card">
                                <span class="update-date">{formatDate(trial.latestUpdate.date)}</span>
                                <p>{trial.latestUpdate.summary}</p>
                            </div>
                        </section>
                    )}

                    <!-- Lead Investigators -->
                    {trial.leadInvestigators && trial.leadInvestigators.length > 0 && (
                        <section class="content-section">
                            <h2>Lead Investigators</h2>
                            <div class="investigators-list">
                                {trial.leadInvestigators.map((inv: any) => (
                                    <div class="investigator-card">
                                        {inv.mdrpediaSlug ? (
                                            <a href={`/doctors/${inv.mdrpediaSlug}`} class="investigator-link">
                                                <div class="investigator-avatar">
                                                    {inv.name.split(' ').map((n: string) => n[0]).slice(0, 2).join('')}
                                                </div>
                                                <div class="investigator-info">
                                                    <span class="investigator-name">{inv.name}</span>
                                                    <span class="investigator-role">{inv.role}</span>
                                                </div>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                                    <polyline points="15 3 21 3 21 9"/>
                                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                                </svg>
                                            </a>
                                        ) : (
                                            <div class="investigator-card-inner">
                                                <div class="investigator-avatar">
                                                    {inv.name.split(' ').map((n: string) => n[0]).slice(0, 2).join('')}
                                                </div>
                                                <div class="investigator-info">
                                                    <span class="investigator-name">{inv.name}</span>
                                                    <span class="investigator-role">{inv.role}</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}
                </main>

                <!-- Sidebar -->
                <aside class="sidebar">
                    <!-- Trial Details -->
                    <div class="sidebar-card">
                        <h3>Trial Details</h3>
                        <dl class="details-list">
                            <div class="detail-row">
                                <dt>Trial ID</dt>
                                <dd>{trial.id.toUpperCase()}</dd>
                            </div>
                            <div class="detail-row">
                                <dt>Phase</dt>
                                <dd>{trial.phase}</dd>
                            </div>
                            <div class="detail-row">
                                <dt>Status</dt>
                                <dd style={`color: ${getStatusColor(trial.status)}`}>{trial.status}</dd>
                            </div>
                            <div class="detail-row">
                                <dt>Start Date</dt>
                                <dd>{formatDate(trial.startDate)}</dd>
                            </div>
                            <div class="detail-row">
                                <dt>Est. Completion</dt>
                                <dd>{formatDate(trial.estimatedCompletion)}</dd>
                            </div>
                        </dl>
                    </div>

                    <!-- Countries -->
                    {trial.countries && trial.countries.length > 0 && (
                        <div class="sidebar-card">
                            <h3>Trial Locations</h3>
                            <div class="countries-list">
                                {trial.countries.map((country: string) => (
                                    <span class="country-tag">{country}</span>
                                ))}
                            </div>
                        </div>
                    )}

                    <!-- Sponsor Info -->
                    <div class="sidebar-card">
                        <h3>Sponsor</h3>
                        <div class="sponsor-card">
                            <img src={company.logo} alt={company.name} class="sponsor-logo-sm" />
                            <div class="sponsor-details">
                                <span class="sponsor-name-sm">{company.name}</span>
                                <span class="sponsor-hq">{company.headquarters}</span>
                                {company.website && (
                                    <a href={company.website} target="_blank" rel="noopener" class="sponsor-link">
                                        Visit Website
                                    </a>
                                )}
                            </div>
                        </div>
                    </div>

                    <!-- Back Link -->
                    <a href="/clinical-trials" class="back-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        All Clinical Trials
                    </a>
                </aside>
            </div>
        </div>
    </div>
</Layout>

<style>
    .trial-page {
        padding: 40px 0 80px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 32px;
        font-size: 0.85rem;
    }

    .breadcrumb a {
        color: var(--text-muted, #64748b);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: var(--accent-purple, #8b5cf6);
    }

    .breadcrumb span {
        color: var(--text-secondary, #94a3b8);
    }

    .breadcrumb svg {
        color: var(--text-muted, #64748b);
    }

    /* Header */
    .trial-header {
        margin-bottom: 40px;
    }

    .trial-meta {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .phase-badge, .status-badge, .category-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .phase-badge {
        background: color-mix(in srgb, var(--phase-color) 15%, transparent);
        color: var(--phase-color);
    }

    .status-badge {
        background: color-mix(in srgb, var(--status-color) 15%, transparent);
        color: var(--status-color);
    }

    .category-badge {
        background: rgba(139, 92, 246, 0.15);
        color: var(--accent-purple, #8b5cf6);
    }

    .trial-header h1 {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0 0 12px;
        line-height: 1.2;
    }

    .indication {
        font-size: 1.2rem;
        color: var(--text-secondary, #94a3b8);
        margin: 0 0 24px;
    }

    .sponsor {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .sponsor-logo {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: white;
        padding: 6px;
        object-fit: contain;
    }

    .sponsor-info {
        display: flex;
        flex-direction: column;
    }

    .sponsor-label {
        font-size: 0.7rem;
        color: var(--text-muted, #64748b);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .sponsor-name {
        font-weight: 600;
        color: var(--text-primary, white);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: var(--bg-card, #14142a);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .stat-card svg {
        color: var(--accent-purple, #8b5cf6);
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary, white);
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--text-muted, #64748b);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 40px;
        align-items: start;
    }

    /* Content Sections */
    .content-section {
        background: var(--bg-card, #14142a);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .content-section h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .content-section p {
        color: var(--text-secondary, #94a3b8);
        line-height: 1.7;
        margin: 0;
    }

    /* Endpoints */
    .endpoints-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .endpoints-list li {
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-secondary, #94a3b8);
    }

    .endpoints-list svg {
        color: #10b981;
        flex-shrink: 0;
    }

    /* Update Section */
    .update-card {
        background: rgba(16, 185, 129, 0.08);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 10px;
        padding: 16px;
    }

    .update-date {
        display: block;
        font-size: 0.75rem;
        color: #10b981;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .update-card p {
        color: var(--text-primary, white);
    }

    /* Investigators */
    .investigators-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .investigator-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        overflow: hidden;
    }

    .investigator-link, .investigator-card-inner {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s;
    }

    .investigator-link:hover {
        background: rgba(139, 92, 246, 0.08);
    }

    .investigator-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent-purple, #8b5cf6), #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: white;
        flex-shrink: 0;
    }

    .investigator-info {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .investigator-name {
        font-weight: 600;
        color: var(--text-primary, white);
    }

    .investigator-role {
        font-size: 0.8rem;
        color: var(--text-muted, #64748b);
    }

    .investigator-link svg {
        color: var(--accent-purple, #8b5cf6);
    }

    /* Sidebar */
    .sidebar-card {
        background: var(--bg-card, #14142a);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .sidebar-card h3 {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #64748b);
        margin: 0 0 16px;
    }

    .details-list {
        margin: 0;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-row dt {
        color: var(--text-muted, #64748b);
        font-size: 0.85rem;
    }

    .detail-row dd {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Countries */
    .countries-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .country-tag {
        padding: 4px 12px;
        background: rgba(139, 92, 246, 0.1);
        color: var(--accent-purple, #8b5cf6);
        border-radius: 16px;
        font-size: 0.75rem;
    }

    /* Sponsor Card */
    .sponsor-card {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .sponsor-logo-sm {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: white;
        padding: 4px;
        object-fit: contain;
    }

    .sponsor-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .sponsor-name-sm {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .sponsor-hq {
        font-size: 0.75rem;
        color: var(--text-muted, #64748b);
    }

    .sponsor-link {
        font-size: 0.75rem;
        color: var(--accent-purple, #8b5cf6);
        text-decoration: none;
    }

    .sponsor-link:hover {
        text-decoration: underline;
    }

    /* Back Link */
    .back-link {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--accent-purple, #8b5cf6);
        text-decoration: none;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }

        .sidebar {
            order: -1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .sidebar .back-link {
            grid-column: span 2;
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .sidebar {
            grid-template-columns: 1fr;
        }

        .sidebar .back-link {
            grid-column: span 1;
        }

        .trial-header h1 {
            font-size: 1.6rem;
        }
    }
</style>
