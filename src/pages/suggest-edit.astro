---
export const prerender = true;
/**
 * MDRPedia ‚Äî Suggest Profile Edit Page
 * Allows users to submit corrections/additions to doctor profiles
 */
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";

const profileSlug = Astro.url.searchParams.get("profile") || "";
const editType = Astro.url.searchParams.get("type") || "general";

// Get doctor info if slug provided
let doctor = null;
if (profileSlug) {
    const allDoctors = await getCollection("doctors");
    doctor = allDoctors.find(d => d.id === profileSlug);
}

const editTypes = {
    citation: { icon: "üìö", title: "Add Citation", description: "Add a research paper, publication, or academic citation" },
    award: { icon: "üèÜ", title: "Add Award", description: "Add an award, honor, or recognition" },
    affiliation: { icon: "üè•", title: "Add Affiliation", description: "Add a hospital, institution, or organization affiliation" },
    general: { icon: "‚úèÔ∏è", title: "General Information", description: "Add or correct other profile information" },
};

const currentType = editTypes[editType as keyof typeof editTypes] || editTypes.general;
---

<Layout title={`Suggest Edit${doctor ? ` ‚Äî ${doctor.data.fullName}` : ''} ‚Äî MDRPedia`}>
    <section class="suggest-page">
        <div class="container">
            <!-- Back Link -->
            {doctor && (
                <a href={`/doctor/${profileSlug}`} class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to {doctor.data.fullName}'s Profile
                </a>
            )}

            <!-- Header -->
            <div class="page-header">
                <div class="header-icon">
                    <span>{currentType.icon}</span>
                </div>
                <h1>{currentType.title}</h1>
                <p class="header-description">{currentType.description}</p>
                {doctor && (
                    <div class="profile-badge">
                        <span class="badge-label">For:</span>
                        <span class="badge-name">{doctor.data.fullName}</span>
                        <span class={`badge-tier badge-tier--${doctor.data.tier.toLowerCase()}`}>{doctor.data.tier}</span>
                    </div>
                )}
            </div>

            <!-- Edit Type Tabs -->
            <div class="type-tabs">
                {Object.entries(editTypes).map(([key, value]) => (
                    <a
                        href={`/suggest-edit?profile=${profileSlug}&type=${key}`}
                        class={`type-tab ${editType === key ? 'type-tab--active' : ''}`}
                    >
                        <span class="tab-icon">{value.icon}</span>
                        <span class="tab-label">{value.title}</span>
                    </a>
                ))}
            </div>

            <!-- Form -->
            <form class="suggest-form" id="suggest-form">
                <input type="hidden" name="profileSlug" value={profileSlug} />
                <input type="hidden" name="editType" value={editType} />

                {/* Citation Form */}
                {editType === "citation" && (
                    <div class="form-section">
                        <div class="form-group">
                            <label for="citationTitle">Publication Title <span class="required">*</span></label>
                            <input type="text" id="citationTitle" name="citationTitle" placeholder="e.g., Novel Approaches to Cardiac Surgery" required />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="citationDOI">DOI</label>
                                <input type="text" id="citationDOI" name="citationDOI" placeholder="e.g., 10.1000/xyz123" />
                            </div>
                            <div class="form-group">
                                <label for="citationPubMed">PubMed ID</label>
                                <input type="text" id="citationPubMed" name="citationPubMed" placeholder="e.g., 12345678" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="citationJournal">Journal</label>
                                <input type="text" id="citationJournal" name="citationJournal" placeholder="e.g., The Lancet" />
                            </div>
                            <div class="form-group">
                                <label for="citationYear">Year</label>
                                <input type="number" id="citationYear" name="citationYear" placeholder="e.g., 2024" min="1900" max="2030" />
                            </div>
                        </div>
                    </div>
                )}

                {/* Award Form */}
                {editType === "award" && (
                    <div class="form-section">
                        <div class="form-group">
                            <label for="awardName">Award Name <span class="required">*</span></label>
                            <input type="text" id="awardName" name="awardName" placeholder="e.g., Nobel Prize in Medicine" required />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="awardYear">Year Received</label>
                                <input type="number" id="awardYear" name="awardYear" placeholder="e.g., 2024" min="1900" max="2030" />
                            </div>
                            <div class="form-group">
                                <label for="awardIssuer">Issuing Organization</label>
                                <input type="text" id="awardIssuer" name="awardIssuer" placeholder="e.g., Nobel Foundation" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="awardContribution">Contribution (why awarded)</label>
                            <textarea id="awardContribution" name="awardContribution" rows="3" placeholder="Brief description of why this award was given..."></textarea>
                        </div>
                    </div>
                )}

                {/* Affiliation Form */}
                {editType === "affiliation" && (
                    <div class="form-section">
                        <div class="form-group">
                            <label for="affiliationName">Institution Name <span class="required">*</span></label>
                            <input type="text" id="affiliationName" name="affiliationName" placeholder="e.g., Johns Hopkins Hospital" required />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="affiliationRole">Role / Position</label>
                                <input type="text" id="affiliationRole" name="affiliationRole" placeholder="e.g., Chief of Cardiology" />
                            </div>
                            <div class="form-group">
                                <label for="affiliationDepartment">Department</label>
                                <input type="text" id="affiliationDepartment" name="affiliationDepartment" placeholder="e.g., Department of Surgery" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="affiliationUrl">Institution Website</label>
                            <input type="url" id="affiliationUrl" name="affiliationUrl" placeholder="https://..." />
                        </div>
                    </div>
                )}

                {/* General Form */}
                {editType === "general" && (
                    <div class="form-section">
                        <div class="form-group">
                            <label for="generalCategory">What would you like to add or correct? <span class="required">*</span></label>
                            <select id="generalCategory" name="generalCategory" required>
                                <option value="">Select a category...</option>
                                <option value="biography">Biography / Summary</option>
                                <option value="specialty">Specialty / Sub-specialty</option>
                                <option value="location">Location / Geography</option>
                                <option value="techniques">Techniques / Procedures</option>
                                <option value="metrics">H-Index / Citations</option>
                                <option value="photo">Profile Photo</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="generalDetails">Details <span class="required">*</span></label>
                            <textarea id="generalDetails" name="generalDetails" rows="5" placeholder="Please provide the information you'd like to add or correct..." required></textarea>
                        </div>
                    </div>
                )}

                {/* Common Fields */}
                <div class="form-section">
                    <div class="form-group">
                        <label for="sourceUrl">Source URL (for verification)</label>
                        <input type="url" id="sourceUrl" name="sourceUrl" placeholder="https://... (link to verify this information)" />
                        <p class="form-hint">Providing a source helps us verify and publish your suggestion faster.</p>
                    </div>

                    <div class="form-group">
                        <label for="submitterEmail">Your Email (optional)</label>
                        <input type="email" id="submitterEmail" name="submitterEmail" placeholder="your@email.com" />
                        <p class="form-hint">We'll notify you when your suggestion is reviewed. Never shared publicly.</p>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn--primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                        Submit Suggestion
                    </button>
                    <p class="submit-note">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        All suggestions are reviewed by our editorial team before publishing.
                    </p>
                </div>
            </form>

            <!-- Success Message (hidden by default) -->
            <div class="success-message" id="success-message" style="display: none;">
                <div class="success-icon">‚úÖ</div>
                <h2>Thank You!</h2>
                <p>Your suggestion has been submitted successfully. Our team will review it shortly.</p>
                {doctor && (
                    <a href={`/doctor/${profileSlug}`} class="btn btn--secondary">
                        Return to Profile
                    </a>
                )}
            </div>
        </div>
    </section>
</Layout>

<script>
    const form = document.getElementById('suggest-form') as HTMLFormElement;
    const successMessage = document.getElementById('success-message');

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/suggest-edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                form.style.display = 'none';
                if (successMessage) successMessage.style.display = 'block';
            } else {
                alert('Failed to submit. Please try again.');
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    });
</script>

<style>
    .suggest-page {
        padding: 48px 0 80px;
        min-height: 70vh;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 24px;
        transition: color 0.15s;
    }

    .back-link:hover {
        color: var(--text-primary);
    }

    .back-link svg {
        width: 18px;
        height: 18px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .header-icon {
        width: 72px;
        height: 72px;
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
        border-radius: 20px;
        font-size: 2rem;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .header-description {
        color: var(--text-muted);
        font-size: 1rem;
        margin-bottom: 16px;
    }

    .profile-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
    }

    .badge-label {
        color: var(--text-muted);
        font-size: 0.85rem;
    }

    .badge-name {
        color: var(--text-primary);
        font-weight: 600;
    }

    .badge-tier {
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
    }

    .badge-tier--titan {
        background: rgba(255, 215, 0, 0.15);
        color: #ffd700;
    }

    .badge-tier--elite {
        background: rgba(0, 170, 255, 0.15);
        color: #00aaff;
    }

    .badge-tier--master {
        background: rgba(0, 204, 102, 0.15);
        color: #00cc66;
    }

    .badge-tier--unranked {
        background: rgba(136, 136, 136, 0.15);
        color: #888;
    }

    /* Type Tabs */
    .type-tabs {
        display: flex;
        gap: 8px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 32px;
    }

    .type-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.15s;
    }

    .type-tab:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-primary);
    }

    .type-tab--active {
        background: rgba(139, 92, 246, 0.15);
        border-color: rgba(139, 92, 246, 0.4);
        color: var(--accent-purple);
    }

    .tab-icon {
        font-size: 1.1rem;
    }

    /* Form */
    .suggest-form {
        max-width: 640px;
        margin: 0 auto;
    }

    .form-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .required {
        color: #ef4444;
    }

    input, textarea, select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 0.15s;
    }

    input::placeholder, textarea::placeholder {
        color: var(--text-muted);
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--accent-purple);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    select {
        cursor: pointer;
    }

    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .form-hint {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 6px;
    }

    /* Form Actions */
    .form-actions {
        text-align: center;
        padding-top: 16px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 28px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn svg {
        width: 18px;
        height: 18px;
    }

    .btn--primary {
        background: var(--accent-purple);
        color: white;
    }

    .btn--primary:hover {
        background: #7c3aed;
        transform: translateY(-2px);
    }

    .btn--secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .submit-note {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 16px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .submit-note svg {
        width: 16px;
        height: 16px;
        color: var(--accent-emerald);
    }

    /* Success Message */
    .success-message {
        text-align: center;
        padding: 60px 20px;
        max-width: 500px;
        margin: 0 auto;
    }

    .success-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .success-message h2 {
        font-size: 1.75rem;
        color: var(--text-primary);
        margin-bottom: 12px;
    }

    .success-message p {
        color: var(--text-muted);
        margin-bottom: 24px;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .type-tabs {
            flex-direction: column;
        }

        .type-tab {
            justify-content: center;
        }
    }
</style>
