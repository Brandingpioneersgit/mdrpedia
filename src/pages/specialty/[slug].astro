---
/**
 * MDRPedia — Specialty Group Landing Page
 * Dynamic pages for each medical specialty category
 * Optimized for SEO with rich structured data
 */
import Layout from "../../layouts/Layout.astro";
import TierBadge from "../../components/TierBadge.astro";
import OptimizedImage from "../../components/OptimizedImage.astro";
import { prisma } from "../../lib/prisma";
import { SPECIALTY_GROUPS, type SpecialtyGroup } from "../../lib/specialty-groups";
import { generateSpecialtyPageSchema } from "../../lib/medical-knowledge-graph";

export const prerender = false;

// Slugify function: convert group name to URL-friendly slug
function slugify(name: string): string {
    return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

// Get the slug from URL params
const { slug } = Astro.params;

// Find the matching specialty group
const group = SPECIALTY_GROUPS.find(g => slugify(g.name) === slug);

// 404 if no matching group
if (!group) {
    return Astro.redirect('/404');
}

// Build OR conditions for each specialty in the group
const specialtyConditions = group.specialties.map(specialty => ({
    specialty: {
        contains: specialty,
        mode: 'insensitive' as const
    }
}));

// Query doctors matching any of the group's specialties
const doctors = await prisma.profile.findMany({
    where: {
        OR: specialtyConditions
    },
    select: {
        slug: true,
        full_name: true,
        title: true,
        specialty: true,
        tier: true,
        status: true,
        ranking_score: true,
        h_index: true,
        portrait_url: true,
        geography: {
            select: {
                country: true,
                city: true
            }
        }
    },
    orderBy: [
        { tier: 'asc' },
        { ranking_score: 'desc' },
        { h_index: 'desc' }
    ]
});

// Sort by tier properly (TITAN > ELITE > MASTER > UNRANKED)
const tierOrder: Record<string, number> = {
    TITAN: 0,
    ELITE: 1,
    MASTER: 2,
    UNRANKED: 3
};

const sortedDoctors = [...doctors].sort((a, b) => {
    const tierDiff = (tierOrder[a.tier] ?? 3) - (tierOrder[b.tier] ?? 3);
    if (tierDiff !== 0) return tierDiff;
    const rankA = a.ranking_score ?? 0;
    const rankB = b.ranking_score ?? 0;
    if (rankB !== rankA) return rankB - rankA;
    return (b.h_index ?? 0) - (a.h_index ?? 0);
});

// Calculate stats
const totalDoctors = sortedDoctors.length;
const titanCount = sortedDoctors.filter(d => d.tier === 'TITAN').length;
const eliteCount = sortedDoctors.filter(d => d.tier === 'ELITE').length;
const uniqueCountries = new Set(sortedDoctors.map(d => d.geography?.country).filter(Boolean));
const countryCount = uniqueCountries.size;

// Get related specialty groups (exclude current)
const relatedGroups = SPECIALTY_GROUPS
    .filter(g => g.name !== group.name)
    .slice(0, 6);

// Page metadata
const pageTitle = `${group.name} Specialists — MDRPedia`;
const pageDescription = `Discover the world's leading ${group.name.toLowerCase()} specialists. ${group.description}. Browse ${totalDoctors} verified physicians including ${titanCount} Titans and ${eliteCount} Elite practitioners.`;
const canonicalUrl = new URL(`/specialty/${slug}`, Astro.site ?? 'https://mdrpedia.com').href;

// Structured Data: CollectionPage
const collectionPageSchema = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": `${group.name} Medical Specialists`,
    "description": pageDescription,
    "url": canonicalUrl,
    "mainEntity": {
        "@type": "ItemList",
        "name": `Top ${group.name} Specialists`,
        "numberOfItems": totalDoctors,
        "itemListElement": sortedDoctors.slice(0, 50).map((doc, index) => ({
            "@type": "ListItem",
            "position": index + 1,
            "item": {
                "@type": "Physician",
                "name": doc.full_name,
                "medicalSpecialty": doc.specialty,
                "url": new URL(`/doctors/${doc.slug}`, Astro.site ?? 'https://mdrpedia.com').href,
                ...(doc.geography?.country && { "workLocation": { "@type": "Place", "name": doc.geography.country } })
            }
        }))
    },
    "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": Astro.site ?? "https://mdrpedia.com" },
            { "@type": "ListItem", "position": 2, "name": "Specialties", "item": `${Astro.site ?? 'https://mdrpedia.com'}/rankings` },
            { "@type": "ListItem", "position": 3, "name": group.name, "item": canonicalUrl }
        ]
    }
};

// Medical Knowledge Graph Schema with @id references
const knowledgeGraphSchema = generateSpecialtyPageSchema(
    group.name,
    sortedDoctors.slice(0, 50).map(d => ({
        fullName: d.full_name,
        slug: d.slug,
        hIndex: d.h_index ?? 0,
        tier: d.tier,
    }))
);
---

<Layout title={pageTitle} description={pageDescription}>
    <!-- Structured Data: Collection Page -->
    <script type="application/ld+json" set:html={JSON.stringify(collectionPageSchema)} />

    <!-- Medical Knowledge Graph with @id references -->
    <script type="application/ld+json" set:html={JSON.stringify(knowledgeGraphSchema)} />

    <div class="specialty-page">
        <!-- Hero Section -->
        <header class="specialty-hero">
            <div class="container">
                <!-- Breadcrumb -->
                <nav class="breadcrumb" aria-label="Breadcrumb">
                    <a href="/">Home</a>
                    <span class="breadcrumb-sep">/</span>
                    <a href="/rankings">Specialties</a>
                    <span class="breadcrumb-sep">/</span>
                    <span class="breadcrumb-current">{group.name}</span>
                </nav>

                <div class="hero-content">
                    <span class="hero-icon">{group.icon}</span>
                    <h1>{group.name}</h1>
                    <p class="hero-description">{group.description}</p>
                </div>

                <!-- Stats Bar -->
                <div class="stats-bar">
                    <div class="stat">
                        <span class="stat-value">{totalDoctors.toLocaleString()}</span>
                        <span class="stat-label">Specialists</span>
                    </div>
                    <div class="stat stat--titan">
                        <span class="stat-value">{titanCount}</span>
                        <span class="stat-label">Titans</span>
                    </div>
                    <div class="stat stat--elite">
                        <span class="stat-value">{eliteCount}</span>
                        <span class="stat-label">Elite</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">{countryCount}</span>
                        <span class="stat-label">Countries</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Subspecialty Tags -->
        <section class="subspecialties">
            <div class="container">
                <h2 class="section-title">Subspecialties</h2>
                <div class="tags-grid">
                    {group.specialties.map(specialty => (
                        <span class="subspecialty-tag">{specialty}</span>
                    ))}
                </div>
            </div>
        </section>

        <!-- Doctors Grid -->
        <section class="doctors-section">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title">Leading Specialists</h2>
                    <span class="section-count">{totalDoctors} physicians</span>
                </div>

                {sortedDoctors.length > 0 ? (
                    <div class="doctors-grid">
                        {sortedDoctors.map(doc => {
                            const location = [doc.geography?.city, doc.geography?.country]
                                .filter(Boolean)
                                .join(', ');
                            const initials = doc.full_name
                                .split(' ')
                                .map((w: string) => w[0])
                                .filter((_: string, i: number) => i < 2)
                                .join('')
                                .toUpperCase();
                            const hasImage = doc.portrait_url && !doc.portrait_url.startsWith('data:');

                            return (
                                <a
                                    href={`/doctors/${doc.slug}`}
                                    class={`doctor-card doctor-card--${doc.tier.toLowerCase()}`}
                                >
                                    <div class="doctor-card__header">
                                        <div class={`doctor-card__avatar avatar--${doc.tier.toLowerCase()}`}>
                                            <OptimizedImage
                                                src={doc.portrait_url}
                                                alt={doc.full_name}
                                                width={64}
                                                height={64}
                                                fallbackInitials={initials}
                                                tier={doc.tier as 'TITAN' | 'ELITE' | 'MASTER' | 'UNRANKED'}
                                            />
                                        </div>
                                        <div class="doctor-card__badges">
                                            <TierBadge
                                                tier={doc.tier as 'TITAN' | 'ELITE' | 'MASTER' | 'UNRANKED'}
                                                size="sm"
                                            />
                                            {doc.status === 'HISTORICAL' && (
                                                <span class="legacy-badge">Legacy</span>
                                            )}
                                        </div>
                                    </div>
                                    <h3 class="doctor-card__name">{doc.full_name}</h3>
                                    <p class="doctor-card__specialty">{doc.specialty}</p>
                                    {location && (
                                        <p class="doctor-card__location">{location}</p>
                                    )}
                                    <div class="doctor-card__stats">
                                        <span class="stat">
                                            <strong>{doc.h_index || '-'}</strong> H-index
                                        </span>
                                    </div>
                                </a>
                            );
                        })}
                    </div>
                ) : (
                    <div class="empty-state">
                        <span class="empty-icon">{group.icon}</span>
                        <h3>No specialists found</h3>
                        <p>We're actively building our database. Check back soon for {group.name.toLowerCase()} specialists.</p>
                    </div>
                )}
            </div>
        </section>

        <!-- Related Specialties -->
        <section class="related-section">
            <div class="container">
                <h2 class="section-title">Explore Other Specialties</h2>
                <div class="related-grid">
                    {relatedGroups.map(related => (
                        <a
                            href={`/specialty/${slugify(related.name)}`}
                            class="related-card"
                        >
                            <span class="related-icon">{related.icon}</span>
                            <div class="related-content">
                                <h3 class="related-name">{related.name}</h3>
                                <p class="related-desc">{related.description}</p>
                            </div>
                            <span class="related-arrow">&#8594;</span>
                        </a>
                    ))}
                </div>
            </div>
        </section>
    </div>
</Layout>

<style>
    .specialty-page {
        background: var(--bg-primary);
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        margin-bottom: 2rem;
    }

    .breadcrumb a {
        color: var(--text-muted);
        text-decoration: none;
        transition: color 0.2s;
    }

    .breadcrumb a:hover {
        color: var(--accent-purple);
    }

    .breadcrumb-sep {
        color: var(--text-muted);
        opacity: 0.5;
    }

    .breadcrumb-current {
        color: var(--text-secondary);
    }

    /* Hero Section */
    .specialty-hero {
        padding: 4rem 0 3rem;
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, transparent 100%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .hero-content {
        text-align: center;
        margin-bottom: 2.5rem;
    }

    .hero-icon {
        display: block;
        font-size: 4rem;
        margin-bottom: 1rem;
        filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.3));
    }

    .specialty-hero h1 {
        font-family: var(--font-serif);
        font-size: clamp(2.5rem, 5vw, 3.5rem);
        font-weight: 800;
        background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-purple-light) 50%, #fff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
    }

    .hero-description {
        font-size: 1.15rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .stat {
        text-align: center;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        min-width: 110px;
    }

    .stat-value {
        display: block;
        font-family: var(--font-mono);
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .stat-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
    }

    .stat--titan .stat-value { color: #ffd700; }
    .stat--elite .stat-value { color: #00aaff; }

    /* Subspecialties Section */
    .subspecialties {
        padding: 3rem 0;
        background: rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .section-title {
        font-family: var(--font-serif);
        font-size: 1.5rem;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
    }

    .tags-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .subspecialty-tag {
        padding: 0.5rem 1rem;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.25);
        border-radius: 100px;
        font-size: 0.85rem;
        color: var(--accent-purple-light);
        text-transform: capitalize;
        transition: all 0.2s;
    }

    .subspecialty-tag:hover {
        background: rgba(139, 92, 246, 0.2);
        border-color: rgba(139, 92, 246, 0.4);
    }

    /* Doctors Section */
    .doctors-section {
        padding: 3rem 0 4rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .section-count {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .doctors-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    /* Doctor Card */
    .doctor-card {
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
        overflow: hidden;
    }

    .doctor-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.03), transparent 70%);
        pointer-events: none;
    }

    .doctor-card:hover {
        transform: translateY(-4px);
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.15);
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.4);
    }

    /* Tier-specific styling */
    .doctor-card--titan {
        background: linear-gradient(145deg, rgba(255, 215, 0, 0.03) 0%, rgba(255, 255, 255, 0.02) 100%);
        border-color: rgba(255, 215, 0, 0.15);
    }

    .doctor-card--titan:hover {
        border-color: rgba(255, 215, 0, 0.4);
        box-shadow: 0 16px 40px rgba(255, 215, 0, 0.1);
    }

    .doctor-card--elite {
        background: linear-gradient(145deg, rgba(0, 170, 255, 0.03) 0%, rgba(255, 255, 255, 0.02) 100%);
        border-color: rgba(0, 170, 255, 0.15);
    }

    .doctor-card--elite:hover {
        border-color: rgba(0, 170, 255, 0.4);
        box-shadow: 0 16px 40px rgba(0, 170, 255, 0.1);
    }

    .doctor-card--master {
        background: linear-gradient(145deg, rgba(0, 204, 102, 0.03) 0%, rgba(255, 255, 255, 0.02) 100%);
        border-color: rgba(0, 204, 102, 0.15);
    }

    .doctor-card--master:hover {
        border-color: rgba(0, 204, 102, 0.4);
        box-shadow: 0 16px 40px rgba(0, 204, 102, 0.1);
    }

    .doctor-card__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .doctor-card__avatar {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .avatar--titan {
        border-color: rgba(255, 215, 0, 0.3);
        background: rgba(255, 215, 0, 0.08);
    }

    .avatar--elite {
        border-color: rgba(0, 170, 255, 0.3);
        background: rgba(0, 170, 255, 0.08);
    }

    .avatar--master {
        border-color: rgba(0, 204, 102, 0.3);
        background: rgba(0, 204, 102, 0.08);
    }

    .doctor-card__avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-initials {
        font-weight: 700;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .avatar--titan .avatar-initials { color: #ffd700; }
    .avatar--elite .avatar-initials { color: #00aaff; }
    .avatar--master .avatar-initials { color: #00cc66; }

    .doctor-card__badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .legacy-badge {
        font-size: 0.65rem;
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-muted);
    }

    .doctor-card__name {
        font-size: 1.15rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.25rem;
        line-height: 1.3;
        letter-spacing: -0.01em;
    }

    .doctor-card--titan .doctor-card__name {
        color: #ffd700;
        text-shadow: 0 2px 10px rgba(255, 215, 0, 0.2);
    }

    .doctor-card__specialty {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .doctor-card__location {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    .doctor-card__stats {
        display: flex;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        margin-top: auto;
    }

    .doctor-card__stats .stat {
        font-size: 0.75rem;
        color: var(--text-muted);
        background: none;
        border: none;
        padding: 0;
        min-width: auto;
    }

    .doctor-card__stats .stat strong {
        color: white;
        font-weight: 700;
        font-size: 1rem;
        font-family: var(--font-mono);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 16px;
    }

    .empty-icon {
        font-size: 4rem;
        opacity: 0.3;
        display: block;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        font-size: 0.95rem;
        color: var(--text-muted);
        max-width: 400px;
        margin: 0 auto;
    }

    /* Related Specialties Section */
    .related-section {
        padding: 4rem 0;
        background: rgba(0, 0, 0, 0.3);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .related-section .section-title {
        text-align: center;
        margin-bottom: 2rem;
    }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1rem;
    }

    .related-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
    }

    .related-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateX(4px);
    }

    .related-icon {
        font-size: 1.75rem;
        flex-shrink: 0;
    }

    .related-content {
        flex: 1;
        min-width: 0;
    }

    .related-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .related-desc {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .related-arrow {
        font-size: 1.25rem;
        color: var(--text-muted);
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
    }

    .related-card:hover .related-arrow {
        opacity: 1;
        transform: translateX(4px);
        color: var(--accent-purple);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .specialty-hero {
            padding: 3rem 0 2rem;
        }

        .hero-icon {
            font-size: 3rem;
        }

        .stats-bar {
            gap: 0.75rem;
        }

        .stat {
            min-width: 80px;
            padding: 0.75rem 1rem;
        }

        .stat-value {
            font-size: 1.25rem;
        }

        .doctors-grid {
            grid-template-columns: 1fr;
        }

        .related-grid {
            grid-template-columns: 1fr;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }
</style>
