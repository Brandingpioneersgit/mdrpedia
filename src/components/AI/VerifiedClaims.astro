---
/**
 * VerifiedClaims - Fact-checked claims with verification badges
 * Displays claims with DOI, PubMed, and institutional verification links
 */

import type { VerifiedClaim } from '../../lib/ai-content-types';

interface Props {
    claims: VerifiedClaim[];
    title?: string;
    tier?: string;
    showAllByDefault?: boolean;
}

const { claims, title = "Verified Claims", tier = "UNRANKED", showAllByDefault = false } = Astro.props;

// Status config
const statusConfig: Record<VerifiedClaim['status'], { label: string; color: string; icon: string }> = {
    VERIFIED: { label: 'Verified', color: '#10b981', icon: 'check-circle' },
    PARTIALLY_VERIFIED: { label: 'Partial', color: '#f59e0b', icon: 'alert-circle' },
    UNVERIFIED: { label: 'Unverified', color: '#6b7280', icon: 'help-circle' },
    DISPUTED: { label: 'Disputed', color: '#ef4444', icon: 'x-circle' },
};

// Claim type icons
const claimTypeIcons: Record<VerifiedClaim['claimType'], string> = {
    INVENTION: 'lightbulb',
    ACHIEVEMENT: 'award',
    STATISTIC: 'bar-chart',
    AFFILIATION: 'building',
    AWARD: 'trophy',
    PUBLICATION: 'book',
    OTHER: 'info',
};

// Sort claims by status (verified first) then by confidence
const sortedClaims = [...claims].sort((a, b) => {
    const statusOrder = { VERIFIED: 0, PARTIALLY_VERIFIED: 1, UNVERIFIED: 2, DISPUTED: 3 };
    if (statusOrder[a.status] !== statusOrder[b.status]) {
        return statusOrder[a.status] - statusOrder[b.status];
    }
    return (b.confidence || 0) - (a.confidence || 0);
});

const initialClaims = showAllByDefault ? sortedClaims : sortedClaims.slice(0, 5);
const hasMore = sortedClaims.length > 5;
---

<section class={`verified-claims-section tier-${tier.toLowerCase()}`}>
    <div class="claims-header">
        <h2 class="claims-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            {title}
        </h2>
        <div class="claims-summary">
            <span class="summary-item summary-item--verified">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <path d="M22 4L12 14.01l-3-3"/>
                </svg>
                {claims.filter(c => c.status === 'VERIFIED').length} Verified
            </span>
            <span class="summary-item">
                {claims.length} Total
            </span>
        </div>
    </div>

    <div class="claims-list" id="claims-list">
        {initialClaims.map((claim, index) => {
            const config = statusConfig[claim.status];
            return (
                <article class={`claim-card claim-card--${claim.status.toLowerCase()}`} data-index={index}>
                    <div class="claim-header">
                        <div class={`status-badge status-badge--${claim.status.toLowerCase()}`}>
                            {claim.status === 'VERIFIED' && (
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                                    <path d="M22 4L12 14.01l-3-3"/>
                                </svg>
                            )}
                            {claim.status === 'PARTIALLY_VERIFIED' && (
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                            )}
                            {claim.status === 'UNVERIFIED' && (
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            )}
                            {claim.status === 'DISPUTED' && (
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                            )}
                            {config.label}
                        </div>
                        <span class="claim-type">{claim.claimType.replace('_', ' ')}</span>
                    </div>

                    <p class="claim-text">{claim.claim}</p>

                    {claim.context && (
                        <p class="claim-context">{claim.context}</p>
                    )}

                    {claim.sources && claim.sources.length > 0 && (
                        <div class="claim-sources">
                            <span class="sources-label">Sources:</span>
                            <div class="sources-list">
                                {claim.sources.map(source => (
                                    <a
                                        href={source.url || (source.type === 'DOI' ? `https://doi.org/${source.identifier}` : source.type === 'PUBMED' ? `https://pubmed.ncbi.nlm.nih.gov/${source.identifier}` : '#')}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class={`source-link source-link--${source.type.toLowerCase()}`}
                                        title={source.title || source.identifier}
                                    >
                                        {source.type === 'DOI' && (
                                            <>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                                                    <polyline points="15 3 21 3 21 9"/>
                                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                                </svg>
                                                DOI
                                            </>
                                        )}
                                        {source.type === 'PUBMED' && (
                                            <>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M4 19.5A2.5 2.5 0 016.5 17H20"/>
                                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/>
                                                </svg>
                                                PubMed
                                            </>
                                        )}
                                        {source.type === 'INSTITUTION' && (
                                            <>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16"/>
                                                    <path d="M3 21h18M9 7h1M9 11h1M9 15h1M14 7h1M14 11h1M14 15h1"/>
                                                </svg>
                                                Institution
                                            </>
                                        )}
                                        {source.type === 'AWARD_BODY' && (
                                            <>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="8" r="7"/>
                                                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                                                </svg>
                                                Award Body
                                            </>
                                        )}
                                        {(source.type === 'NEWS' || source.type === 'OTHER') && (
                                            <>
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <line x1="12" y1="16" x2="12" y2="12"/>
                                                    <line x1="12" y1="8" x2="12.01" y2="8"/>
                                                </svg>
                                                {source.type === 'NEWS' ? 'News' : 'Source'}
                                            </>
                                        )}
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}

                    {claim.confidence !== undefined && (
                        <div class="claim-confidence">
                            <span class="confidence-label">Confidence</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style={`width: ${claim.confidence}%`}></div>
                            </div>
                            <span class="confidence-value">{claim.confidence}%</span>
                        </div>
                    )}

                    {claim.verificationDate && (
                        <div class="claim-meta">
                            Last verified: {new Date(claim.verificationDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                        </div>
                    )}
                </article>
            );
        })}
    </div>

    {hasMore && !showAllByDefault && (
        <button class="show-more-btn" id="show-more-claims" data-total={sortedClaims.length}>
            Show all {sortedClaims.length} claims
        </button>
    )}

    <!-- Hidden semantic content for AI crawlers -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>All Verified Claims</h3>
        {sortedClaims.map(claim => (
            <div>
                <p><strong>{claim.status}:</strong> {claim.claim}</p>
                {claim.sources?.map(s => (
                    <p>Source: {s.type} - {s.identifier}</p>
                ))}
            </div>
        ))}
    </div>
</section>

<style>
    .verified-claims-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .claims-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        flex-wrap: wrap;
    }

    .claims-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .claims-title svg {
        color: #10b981;
        opacity: 0.9;
    }

    .claims-summary {
        display: flex;
        gap: 1rem;
    }

    .summary-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        color: var(--text-muted, #888);
    }

    .summary-item--verified {
        color: #10b981;
        font-weight: 600;
    }

    .summary-item svg {
        color: #10b981;
    }

    /* Claims List */
    .claims-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .claim-card {
        padding: 1.25rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .claim-card:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .claim-card--verified {
        border-left: 3px solid #10b981;
    }

    .claim-card--partially_verified {
        border-left: 3px solid #f59e0b;
    }

    .claim-card--unverified {
        border-left: 3px solid #6b7280;
    }

    .claim-card--disputed {
        border-left: 3px solid #ef4444;
    }

    .claim-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-badge--verified {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }

    .status-badge--partially_verified {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .status-badge--unverified {
        background: rgba(107, 114, 128, 0.15);
        color: #9ca3af;
    }

    .status-badge--disputed {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .claim-type {
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 4px;
    }

    .claim-text {
        font-size: 1rem;
        line-height: 1.6;
        color: var(--text-primary, #fff);
        margin: 0 0 0.75rem;
    }

    .claim-context {
        font-size: 0.85rem;
        line-height: 1.5;
        color: var(--text-muted, #888);
        margin: 0 0 0.75rem;
        font-style: italic;
    }

    /* Sources */
    .claim-sources {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
    }

    .sources-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .sources-list {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .source-link {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 3px 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-secondary, #ccc);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .source-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary, #fff);
    }

    .source-link--doi {
        background: rgba(139, 92, 246, 0.1);
        border-color: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
    }

    .source-link--doi:hover {
        background: rgba(139, 92, 246, 0.2);
    }

    .source-link--pubmed {
        background: rgba(0, 102, 153, 0.1);
        border-color: rgba(0, 102, 153, 0.2);
        color: #00aaff;
    }

    .source-link--pubmed:hover {
        background: rgba(0, 102, 153, 0.2);
    }

    /* Confidence Bar */
    .claim-confidence {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .confidence-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-muted, #888);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .confidence-bar {
        flex: 1;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #8b5cf6);
        border-radius: 2px;
        transition: width 0.5s ease;
    }

    .confidence-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary, #ccc);
        min-width: 35px;
        text-align: right;
    }

    .claim-meta {
        font-size: 0.7rem;
        color: var(--text-muted, #888);
    }

    /* Show More Button */
    .show-more-btn {
        display: block;
        width: 100%;
        margin-top: 1rem;
        padding: 0.75rem;
        background: transparent;
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-muted, #888);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .show-more-btn:hover {
        background: rgba(255, 255, 255, 0.03);
        border-color: rgba(255, 255, 255, 0.25);
        color: var(--text-secondary, #ccc);
    }

    /* Tier colors */
    .tier-titan .claims-title svg { color: #ffd700; }
    .tier-elite .claims-title svg { color: #00aaff; }
    .tier-master .claims-title svg { color: #00cc66; }

    /* Responsive */
    @media (max-width: 640px) {
        .claims-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .claim-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .verified-claims-section {
            padding: 1.5rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const showMoreBtn = document.getElementById('show-more-claims');
        if (showMoreBtn) {
            showMoreBtn.addEventListener('click', () => {
                // For now, just hide the button - full implementation would load more claims
                showMoreBtn.style.display = 'none';
            });
        }
    });
</script>
