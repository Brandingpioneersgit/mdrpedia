---
/**
 * EnhancedFAQ - Category tabs with expandable Q&A accordion
 * Organizes FAQs by category with search and filtering
 */

import type { EnhancedFAQData } from '../../lib/types';

interface Props {
    faqs: EnhancedFAQData[];
    title?: string;
    tier?: string;
    doctorName?: string;
}

const { faqs, title = "Frequently Asked Questions", tier = "UNRANKED", doctorName = "this physician" } = Astro.props;

// Category configuration
const categoryConfig: Record<EnhancedFAQData['category'], { label: string; icon: string }> = {
    GENERAL: { label: 'General', icon: 'info' },
    EXPERTISE: { label: 'Expertise', icon: 'star' },
    CREDENTIALS: { label: 'Credentials', icon: 'award' },
    RESEARCH: { label: 'Research', icon: 'book' },
    PROCEDURES: { label: 'Procedures', icon: 'activity' },
    CONTACT: { label: 'Contact', icon: 'phone' },
    HISTORY: { label: 'History', icon: 'clock' },
};

// Group FAQs by category
const faqsByCategory = faqs.reduce((acc, faq) => {
    if (!acc[faq.category]) acc[faq.category] = [];
    acc[faq.category].push(faq);
    return acc;
}, {} as Record<string, EnhancedFAQData[]>);

// Sort FAQs within each category by priority
Object.keys(faqsByCategory).forEach(cat => {
    faqsByCategory[cat].sort((a, b) => a.priority - b.priority);
});

const categories = Object.keys(faqsByCategory) as EnhancedFAQData['category'][];
const firstCategory = categories[0] || 'GENERAL';
---

<section class={`enhanced-faq-section tier-${tier.toLowerCase()}`}>
    <div class="faq-header">
        <h2 class="faq-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            {title}
        </h2>
        <span class="faq-count">{faqs.length} questions</span>
    </div>

    <!-- Category Tabs -->
    {categories.length > 1 && (
        <div class="category-tabs" role="tablist">
            {categories.map((cat, index) => (
                <button
                    class={`category-tab ${index === 0 ? 'category-tab--active' : ''}`}
                    data-category={cat}
                    role="tab"
                    aria-selected={index === 0 ? "true" : "false"}
                >
                    {categoryConfig[cat]?.label || cat}
                    <span class="tab-count">{faqsByCategory[cat].length}</span>
                </button>
            ))}
        </div>
    )}

    <!-- FAQ Content Panels -->
    <div class="faq-panels">
        {categories.map((cat, catIndex) => (
            <div
                class={`faq-panel ${catIndex === 0 ? 'faq-panel--active' : ''}`}
                data-category={cat}
                role="tabpanel"
            >
                <div class="faq-accordion">
                    {faqsByCategory[cat].map((faq, index) => (
                        <div class="faq-item" data-index={index}>
                            <button
                                class="faq-question"
                                aria-expanded="false"
                            >
                                <span class="question-text">{faq.question}</span>
                                <svg class="question-chevron" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </button>
                            <div class="faq-answer">
                                <p class="answer-text">{faq.answer}</p>
                                {faq.relatedTopics && faq.relatedTopics.length > 0 && (
                                    <div class="related-topics">
                                        <span class="related-label">Related:</span>
                                        {faq.relatedTopics.map(topic => (
                                            <span class="related-tag">{topic}</span>
                                        ))}
                                    </div>
                                )}
                                {faq.lastUpdated && (
                                    <p class="answer-updated">
                                        Last updated: {new Date(faq.lastUpdated).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
                                    </p>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        ))}
    </div>

    <!-- Hidden semantic content for AI crawlers -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>FAQPage: {doctorName}</h3>
        {faqs.map(faq => (
            <div>
                <h4>Q: {faq.question}</h4>
                <p>A: {faq.answer}</p>
                <p>Category: {faq.category}</p>
            </div>
        ))}
    </div>
</section>

<style>
    .enhanced-faq-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .faq-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .faq-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .faq-title svg {
        color: var(--accent, #8b5cf6);
        opacity: 0.8;
    }

    .faq-count {
        font-size: 0.8rem;
        color: var(--text-muted, #888);
    }

    /* Category Tabs */
    .category-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
        -webkit-overflow-scrolling: touch;
    }

    .category-tab {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-muted, #888);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s ease;
    }

    .category-tab:hover {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-secondary, #ccc);
    }

    .category-tab--active {
        background: var(--accent, #8b5cf6);
        border-color: var(--accent, #8b5cf6);
        color: white;
    }

    .tab-count {
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .category-tab--active .tab-count {
        background: rgba(255, 255, 255, 0.25);
    }

    /* FAQ Panels */
    .faq-panel {
        display: none;
    }

    .faq-panel--active {
        display: block;
    }

    /* FAQ Accordion */
    .faq-accordion {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .faq-item {
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 10px;
        overflow: hidden;
    }

    .faq-question {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        width: 100%;
        padding: 1rem 1.25rem;
        background: rgba(255, 255, 255, 0.02);
        border: none;
        cursor: pointer;
        text-align: left;
        transition: background 0.2s ease;
    }

    .faq-question:hover {
        background: rgba(255, 255, 255, 0.04);
    }

    .question-text {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary, #fff);
        line-height: 1.4;
    }

    .question-chevron {
        flex-shrink: 0;
        color: var(--text-muted, #888);
        transition: transform 0.2s ease;
    }

    .faq-question[aria-expanded="true"] .question-chevron {
        transform: rotate(180deg);
    }

    .faq-answer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .faq-item.faq-item--open .faq-answer {
        max-height: 500px;
    }

    .answer-text {
        padding: 0 1.25rem 1rem;
        font-size: 0.95rem;
        line-height: 1.7;
        color: var(--text-secondary, #ccc);
        margin: 0;
    }

    .related-topics {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        padding: 0 1.25rem 1rem;
    }

    .related-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .related-tag {
        padding: 3px 10px;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 100px;
        font-size: 0.75rem;
        color: #a78bfa;
    }

    .answer-updated {
        padding: 0 1.25rem 1rem;
        font-size: 0.7rem;
        color: var(--text-muted, #888);
        margin: 0;
    }

    /* Tier colors */
    .tier-titan .faq-title svg { color: #ffd700; }
    .tier-titan .category-tab--active { background: linear-gradient(135deg, #ffd700, #f59e0b); }
    .tier-elite .faq-title svg { color: #00aaff; }
    .tier-elite .category-tab--active { background: linear-gradient(135deg, #00aaff, #0070f3); }
    .tier-master .faq-title svg { color: #00cc66; }
    .tier-master .category-tab--active { background: linear-gradient(135deg, #00cc66, #10b981); }

    /* Responsive */
    @media (max-width: 640px) {
        .enhanced-faq-section {
            padding: 1.5rem;
        }

        .faq-question {
            padding: 0.875rem 1rem;
        }

        .answer-text,
        .related-topics,
        .answer-updated {
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Category tab switching
        const tabs = document.querySelectorAll('.category-tab');
        const panels = document.querySelectorAll('.faq-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const category = (tab as HTMLElement).dataset.category;

                // Update tabs
                tabs.forEach(t => {
                    t.classList.remove('category-tab--active');
                    t.setAttribute('aria-selected', 'false');
                });
                tab.classList.add('category-tab--active');
                tab.setAttribute('aria-selected', 'true');

                // Update panels
                panels.forEach(panel => {
                    if ((panel as HTMLElement).dataset.category === category) {
                        panel.classList.add('faq-panel--active');
                    } else {
                        panel.classList.remove('faq-panel--active');
                    }
                });
            });
        });

        // FAQ accordion
        const questions = document.querySelectorAll('.faq-question');
        questions.forEach(question => {
            question.addEventListener('click', () => {
                const item = question.closest('.faq-item');
                const isOpen = question.getAttribute('aria-expanded') === 'true';

                // Close all others in this panel
                const panel = question.closest('.faq-panel');
                panel?.querySelectorAll('.faq-item').forEach(i => {
                    i.classList.remove('faq-item--open');
                    i.querySelector('.faq-question')?.setAttribute('aria-expanded', 'false');
                });

                // Toggle current
                if (!isOpen) {
                    item?.classList.add('faq-item--open');
                    question.setAttribute('aria-expanded', 'true');
                }
            });
        });
    });
</script>
