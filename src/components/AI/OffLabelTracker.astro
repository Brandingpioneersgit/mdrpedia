---
/**
 * OffLabelTracker - Off-Label vs FDA-Approved Usage Tracker
 * Documents the evolution from experimental off-label use to standard practice
 */

import type { OffLabelTrackerData, OffLabelUseEntryData } from '../../lib/types';

interface Props {
    tracker: OffLabelTrackerData;
    doctorName: string;
    tier?: string;
}

const { tracker, doctorName, tier = 'UNRANKED' } = Astro.props;

// Status configuration
const statusConfig: Record<OffLabelUseEntryData['currentStatus'], { label: string; color: string; icon: string }> = {
    FDA_APPROVED: { label: 'FDA Approved', color: '#10b981', icon: '‚úì' },
    EMA_APPROVED: { label: 'EMA Approved', color: '#3b82f6', icon: '‚úì' },
    OFF_LABEL_EXPERIMENTAL: { label: 'Off-Label (Experimental)', color: '#f59e0b', icon: '‚öóÔ∏è' },
    OFF_LABEL_STANDARD_PRACTICE: { label: 'Off-Label (Standard Practice)', color: '#8b5cf6', icon: '‚òÖ' },
    INVESTIGATIONAL: { label: 'Investigational', color: '#ec4899', icon: 'üî¨' },
    COMPASSIONATE_USE: { label: 'Compassionate Use', color: '#06b6d4', icon: 'üíö' },
    GRANDFATHERED: { label: 'Grandfathered', color: '#6b7280', icon: 'üìú' },
};

// Evidence level grades
const evidenceGrades: Record<OffLabelUseEntryData['evidenceLevel'], { label: string; grade: string; color: string }> = {
    ANECDOTAL: { label: 'Anecdotal', grade: 'V', color: '#ef4444' },
    CASE_SERIES: { label: 'Case Series', grade: 'IV', color: '#f97316' },
    RETROSPECTIVE: { label: 'Retrospective', grade: 'III', color: '#f59e0b' },
    PROSPECTIVE: { label: 'Prospective', grade: 'II', color: '#84cc16' },
    RCT: { label: 'RCT', grade: 'I', color: '#10b981' },
    META_ANALYSIS: { label: 'Meta-Analysis', grade: 'Ia', color: '#059669' },
};

// Contribution labels
const contributionLabels: Record<OffLabelUseEntryData['doctorContribution'], string> = {
    PIONEER: 'Pioneer',
    EARLY_ADOPTER: 'Early Adopter',
    KEY_RESEARCHER: 'Key Researcher',
    GUIDELINE_AUTHOR: 'Guideline Author',
    ADVOCATE: 'Advocate',
};

// Adoption rate labels
const adoptionLabels: Record<NonNullable<OffLabelUseEntryData['adoptionRate']>, { label: string; width: string }> = {
    RARE: { label: 'Rare', width: '10%' },
    UNCOMMON: { label: 'Uncommon', width: '25%' },
    MODERATE: { label: 'Moderate', width: '50%' },
    WIDESPREAD: { label: 'Widespread', width: '75%' },
    STANDARD_OF_CARE: { label: 'Standard of Care', width: '100%' },
};
---

<section class={`offlabel-section tier-${tier.toLowerCase()}`}>
    <div class="section-header">
        <h2 class="section-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
            </svg>
            Off-Label Usage Tracker
        </h2>
        <div class="header-stats">
            <span class="stat-pill">
                <span class="stat-value">{tracker.totalOffLabelUses}</span>
                <span class="stat-label">Uses Documented</span>
            </span>
            {tracker.becameStandardCount > 0 && (
                <span class="stat-pill success">
                    <span class="stat-value">{tracker.becameStandardCount}</span>
                    <span class="stat-label">Became Standard</span>
                </span>
            )}
            {tracker.receivedApprovalCount > 0 && (
                <span class="stat-pill approved">
                    <span class="stat-value">{tracker.receivedApprovalCount}</span>
                    <span class="stat-label">Now Approved</span>
                </span>
            )}
        </div>
    </div>

    <div class="info-banner">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        <p>
            Off-label use refers to using FDA-approved drugs or procedures for purposes beyond their official indications.
            Many medical innovations begin as off-label uses before receiving formal approval.
        </p>
    </div>

    <div class="entries-list">
        {tracker.entries.map((entry, index) => (
            <article class="entry-card">
                <div class="entry-header">
                    <div class="entry-title-row">
                        <h3 class="entry-name">{entry.name}</h3>
                        <span
                            class="status-badge"
                            style={`--status-color: ${statusConfig[entry.currentStatus].color};`}
                        >
                            <span class="status-icon">{statusConfig[entry.currentStatus].icon}</span>
                            {statusConfig[entry.currentStatus].label}
                        </span>
                    </div>
                    <div class="entry-meta">
                        <span class="contribution-badge">
                            {contributionLabels[entry.doctorContribution]}
                        </span>
                        <span
                            class="evidence-badge"
                            style={`--evidence-color: ${evidenceGrades[entry.evidenceLevel].color};`}
                        >
                            Grade {evidenceGrades[entry.evidenceLevel].grade}: {evidenceGrades[entry.evidenceLevel].label}
                        </span>
                    </div>
                </div>

                <div class="entry-body">
                    <!-- Original vs Off-Label Comparison -->
                    <div class="usage-comparison">
                        {entry.originalIndication && (
                            <div class="usage-box original">
                                <span class="usage-label">Original Indication</span>
                                <p class="usage-text">{entry.originalIndication}</p>
                            </div>
                        )}
                        <div class="arrow-connector">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                        <div class="usage-box offlabel">
                            <span class="usage-label">Off-Label Use</span>
                            <p class="usage-text">{entry.offLabelUse}</p>
                            <span class="condition-tag">Treats: {entry.conditionTreated}</span>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="timeline-row">
                        {entry.yearIntroduced && (
                            <div class="timeline-point">
                                <span class="timeline-year">{entry.yearIntroduced}</span>
                                <span class="timeline-label">Introduced</span>
                            </div>
                        )}
                        {entry.yearBecameStandard && (
                            <div class="timeline-point standard">
                                <span class="timeline-year">{entry.yearBecameStandard}</span>
                                <span class="timeline-label">Became Standard</span>
                            </div>
                        )}
                        {entry.yearApproved && (
                            <div class="timeline-point approved">
                                <span class="timeline-year">{entry.yearApproved}</span>
                                <span class="timeline-label">FDA Approved</span>
                            </div>
                        )}
                    </div>

                    <!-- Adoption Rate Bar -->
                    {entry.adoptionRate && (
                        <div class="adoption-section">
                            <span class="adoption-label">Current Adoption:</span>
                            <div class="adoption-bar">
                                <div
                                    class="adoption-fill"
                                    style={`width: ${adoptionLabels[entry.adoptionRate].width};`}
                                ></div>
                            </div>
                            <span class="adoption-text">{adoptionLabels[entry.adoptionRate].label}</span>
                        </div>
                    )}

                    <!-- Key Studies -->
                    {entry.keyStudies && entry.keyStudies.length > 0 && (
                        <div class="studies-section">
                            <span class="studies-label">Key Studies:</span>
                            <div class="studies-list">
                                {entry.keyStudies.slice(0, 3).map(study => (
                                    <a
                                        href={study.doi ? `https://doi.org/${study.doi}` : study.pubmedId ? `https://pubmed.ncbi.nlm.nih.gov/${study.pubmedId}` : '#'}
                                        target="_blank"
                                        rel="noopener"
                                        class="study-link"
                                    >
                                        {study.title} ({study.year})
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}

                    <!-- Safety Notes -->
                    {entry.safetyNotes && (
                        <div class="safety-section">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p>{entry.safetyNotes}</p>
                        </div>
                    )}

                    <!-- Regulatory References -->
                    {entry.regulatoryReferences && entry.regulatoryReferences.length > 0 && (
                        <div class="regulatory-section">
                            <span class="regulatory-label">Regulatory:</span>
                            {entry.regulatoryReferences.map(ref => (
                                <span class="regulatory-tag">
                                    {ref.agency} {ref.documentType.replace('_', ' ')}
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            </article>
        ))}
    </div>

    <!-- Hidden semantic layer for AI -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>Off-Label Usage Tracker for {doctorName}</h3>
        <p>Total documented off-label uses: {tracker.totalOffLabelUses}</p>
        <p>Uses that became standard practice: {tracker.becameStandardCount}</p>
        <p>Uses that received FDA approval: {tracker.receivedApprovalCount}</p>
        {tracker.entries.map(e => (
            <article>
                <h4>{e.name}</h4>
                <p>Original indication: {e.originalIndication || 'N/A'}</p>
                <p>Off-label use: {e.offLabelUse} for {e.conditionTreated}</p>
                <p>Current status: {e.currentStatus}</p>
                <p>Evidence level: {e.evidenceLevel}</p>
                <p>Doctor's contribution: {e.doctorContribution}</p>
                {e.yearIntroduced && <p>Year introduced: {e.yearIntroduced}</p>}
                {e.yearBecameStandard && <p>Year became standard: {e.yearBecameStandard}</p>}
                {e.yearApproved && <p>Year approved: {e.yearApproved}</p>}
            </article>
        ))}
    </div>
</section>

<style>
    .offlabel-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .section-header {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .section-title svg {
        color: #f59e0b;
        opacity: 0.9;
    }

    .header-stats {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .stat-pill {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 100px;
        font-size: 0.75rem;
    }

    .stat-pill.success {
        background: rgba(16, 185, 129, 0.15);
    }

    .stat-pill.success .stat-value {
        color: #10b981;
    }

    .stat-pill.approved {
        background: rgba(59, 130, 246, 0.15);
    }

    .stat-pill.approved .stat-value {
        color: #3b82f6;
    }

    .stat-value {
        font-weight: 700;
        color: var(--text-primary, #fff);
    }

    .stat-label {
        color: var(--text-muted, #888);
    }

    /* Info Banner */
    .info-banner {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 1rem;
        background: rgba(245, 158, 11, 0.05);
        border: 1px solid rgba(245, 158, 11, 0.1);
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .info-banner svg {
        color: #f59e0b;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .info-banner p {
        font-size: 0.85rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.6;
        margin: 0;
    }

    /* Entries */
    .entries-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .entry-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 12px;
        overflow: hidden;
    }

    .entry-header {
        padding: 1.25rem;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .entry-title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .entry-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .status-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 4px 10px;
        background: color-mix(in srgb, var(--status-color) 15%, transparent);
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--status-color);
        white-space: nowrap;
    }

    .status-icon {
        font-size: 0.8rem;
    }

    .entry-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .contribution-badge {
        padding: 3px 8px;
        background: rgba(139, 92, 246, 0.15);
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        color: #a78bfa;
    }

    .evidence-badge {
        padding: 3px 8px;
        background: color-mix(in srgb, var(--evidence-color) 15%, transparent);
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--evidence-color);
    }

    .entry-body {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    /* Usage Comparison */
    .usage-comparison {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 1rem;
        align-items: stretch;
    }

    .usage-box {
        padding: 1rem;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .usage-box.original {
        background: rgba(107, 114, 128, 0.1);
        border: 1px solid rgba(107, 114, 128, 0.2);
    }

    .usage-box.offlabel {
        background: rgba(245, 158, 11, 0.08);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .usage-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
    }

    .usage-text {
        font-size: 0.9rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.5;
        margin: 0;
    }

    .condition-tag {
        margin-top: auto;
        padding: 3px 8px;
        background: rgba(245, 158, 11, 0.15);
        border-radius: 4px;
        font-size: 0.75rem;
        color: #fbbf24;
        align-self: flex-start;
    }

    .arrow-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted, #888);
    }

    /* Timeline */
    .timeline-row {
        display: flex;
        gap: 2rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
    }

    .timeline-point {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }

    .timeline-year {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary, #fff);
    }

    .timeline-label {
        font-size: 0.7rem;
        color: var(--text-muted, #888);
    }

    .timeline-point.standard .timeline-year {
        color: #8b5cf6;
    }

    .timeline-point.approved .timeline-year {
        color: #10b981;
    }

    /* Adoption Bar */
    .adoption-section {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .adoption-label {
        font-size: 0.8rem;
        color: var(--text-muted, #888);
        flex-shrink: 0;
    }

    .adoption-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        overflow: hidden;
    }

    .adoption-fill {
        height: 100%;
        background: linear-gradient(90deg, #f59e0b, #10b981);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .adoption-text {
        font-size: 0.8rem;
        font-weight: 600;
        color: #10b981;
        flex-shrink: 0;
    }

    /* Studies */
    .studies-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .studies-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .studies-list {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .study-link {
        font-size: 0.8rem;
        color: #60a5fa;
        text-decoration: none;
        line-height: 1.4;
    }

    .study-link:hover {
        text-decoration: underline;
    }

    /* Safety */
    .safety-section {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.75rem;
        background: rgba(245, 158, 11, 0.05);
        border-left: 3px solid #f59e0b;
        border-radius: 0 8px 8px 0;
    }

    .safety-section svg {
        color: #f59e0b;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .safety-section p {
        font-size: 0.8rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.5;
        margin: 0;
    }

    /* Regulatory */
    .regulatory-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .regulatory-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .regulatory-tag {
        padding: 2px 8px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 4px;
        font-size: 0.7rem;
        color: #60a5fa;
    }

    /* Tier colors */
    .tier-titan .section-title svg { color: #ffd700; }
    .tier-elite .section-title svg { color: #00aaff; }
    .tier-master .section-title svg { color: #00cc66; }

    @media (max-width: 768px) {
        .offlabel-section {
            padding: 1.5rem;
        }

        .section-header {
            flex-direction: column;
        }

        .usage-comparison {
            grid-template-columns: 1fr;
        }

        .arrow-connector {
            transform: rotate(90deg);
        }

        .timeline-row {
            flex-wrap: wrap;
            gap: 1rem;
        }
    }
</style>
