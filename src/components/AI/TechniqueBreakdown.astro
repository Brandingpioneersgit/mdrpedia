---
/**
 * TechniqueBreakdown - Step-by-step procedure visualization
 * Shows medical techniques with numbered steps, instruments, and outcomes
 */

import type { TechniqueBreakdown } from '../../lib/ai-content-types';

interface Props {
    technique: TechniqueBreakdown;
    tier?: string;
}

const { technique, tier = "UNRANKED" } = Astro.props;

// Complexity badge config
const complexityConfig: Record<TechniqueBreakdown['complexity'], { label: string; color: string }> = {
    LOW: { label: 'Routine', color: '#10b981' },
    MEDIUM: { label: 'Moderate', color: '#3b82f6' },
    HIGH: { label: 'Complex', color: '#f59e0b' },
    VERY_HIGH: { label: 'Highly Complex', color: '#ef4444' },
};

const complexityInfo = complexityConfig[technique.complexity];
---

<section class={`technique-section tier-${tier.toLowerCase()}`}>
    <div class="technique-header">
        <div class="header-main">
            <h2 class="technique-title">
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
                {technique.techniqueName}
            </h2>
            <div class="technique-meta">
                <span class="complexity-badge" style={`--badge-color: ${complexityInfo.color};`}>
                    {complexityInfo.label}
                </span>
                {technique.totalDuration && (
                    <span class="duration-badge">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v6l4 2"/>
                        </svg>
                        {technique.totalDuration}
                    </span>
                )}
                {technique.yearInvented && (
                    <span class="year-badge">Est. {technique.yearInvented}</span>
                )}
            </div>
        </div>
        {technique.inventedBy && (
            <p class="technique-inventor">
                Pioneered by <strong>{technique.inventedBy}</strong>
            </p>
        )}
    </div>

    <!-- ELI5 / Clinical Toggle Summary -->
    <div class="summary-section">
        <div class="summary-toggle" role="tablist">
            <button class="summary-tab summary-tab--active" data-target="eli5-summary" role="tab" aria-selected="true">
                Simple Explanation
            </button>
            <button class="summary-tab" data-target="clinical-summary" role="tab" aria-selected="false">
                Clinical Description
            </button>
        </div>
        <div class="summary-content">
            <div id="eli5-summary" class="summary-panel summary-panel--active">
                <p>{technique.eli5Summary}</p>
            </div>
            <div id="clinical-summary" class="summary-panel">
                <p>{technique.clinicalSummary}</p>
            </div>
        </div>
    </div>

    <!-- Instruments Used -->
    {technique.instruments && technique.instruments.length > 0 && (
        <div class="instruments-section">
            <h3 class="section-subtitle">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
                Instruments & Equipment
            </h3>
            <div class="instruments-grid">
                {technique.instruments.map(instrument => (
                    <div class={`instrument-card ${instrument.isSpecialized ? 'instrument-card--specialized' : ''}`}>
                        <span class="instrument-name">{instrument.name}</span>
                        {instrument.purpose && (
                            <span class="instrument-purpose">{instrument.purpose}</span>
                        )}
                        {instrument.isSpecialized && (
                            <span class="specialized-badge">Specialized</span>
                        )}
                    </div>
                ))}
            </div>
        </div>
    )}

    <!-- Step-by-Step Breakdown -->
    <div class="steps-section">
        <h3 class="section-subtitle">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                <path d="M9 14l2 2 4-4"/>
            </svg>
            Procedure Steps
        </h3>
        <div class="steps-accordion">
            {technique.steps.map((step, index) => (
                <div class="step-item" data-step={step.stepNumber}>
                    <button class="step-header" aria-expanded={index === 0 ? "true" : "false"}>
                        <div class="step-number">{step.stepNumber}</div>
                        <div class="step-header-content">
                            <h4 class="step-title">{step.title}</h4>
                            {step.duration && (
                                <span class="step-duration">{step.duration}</span>
                            )}
                        </div>
                        <svg class="step-chevron" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>
                    <div class={`step-content ${index === 0 ? 'step-content--open' : ''}`}>
                        <p class="step-description">{step.description}</p>

                        {step.instruments && step.instruments.length > 0 && (
                            <div class="step-instruments">
                                <span class="step-label">Instruments:</span>
                                <div class="step-instruments-list">
                                    {step.instruments.map(inst => (
                                        <span class="mini-instrument">{inst.name}</span>
                                    ))}
                                </div>
                            </div>
                        )}

                        {step.criticalPoints && step.criticalPoints.length > 0 && (
                            <div class="step-critical">
                                <span class="step-label">Critical Points:</span>
                                <ul class="critical-list">
                                    {step.criticalPoints.map(point => (
                                        <li>{point}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {step.risks && step.risks.length > 0 && (
                            <div class="step-risks">
                                <span class="step-label step-label--warning">Risks:</span>
                                <ul class="risks-list">
                                    {step.risks.map(risk => (
                                        <li>{risk}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                </div>
            ))}
        </div>
    </div>

    <!-- Outcomes Section -->
    {technique.outcomes && (
        <div class="outcomes-section">
            <h3 class="section-subtitle">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <path d="M22 4L12 14.01l-3-3"/>
                </svg>
                Expected Outcomes
            </h3>
            <div class="outcomes-grid">
                {technique.outcomes.successRate !== undefined && (
                    <div class="outcome-card outcome-card--success">
                        <span class="outcome-value">{technique.outcomes.successRate}%</span>
                        <span class="outcome-label">Success Rate</span>
                    </div>
                )}
                {technique.outcomes.recoveryTime && (
                    <div class="outcome-card">
                        <span class="outcome-value">{technique.outcomes.recoveryTime}</span>
                        <span class="outcome-label">Recovery Time</span>
                    </div>
                )}
            </div>
            {technique.outcomes.complications && technique.outcomes.complications.length > 0 && (
                <div class="complications-section">
                    <span class="complications-title">Potential Complications:</span>
                    <div class="complications-list">
                        {technique.outcomes.complications.map(comp => (
                            <span class="complication-tag">{comp}</span>
                        ))}
                    </div>
                </div>
            )}
        </div>
    )}

    <!-- Related Techniques -->
    {technique.relatedTechniques && technique.relatedTechniques.length > 0 && (
        <div class="related-section">
            <h3 class="section-subtitle">Related Techniques</h3>
            <div class="related-tags">
                {technique.relatedTechniques.map(tech => (
                    <span class="related-tag">{tech}</span>
                ))}
            </div>
        </div>
    )}

    <!-- Source & Verification -->
    <div class="technique-footer">
        {technique.sourceUrl && (
            <a href={technique.sourceUrl} target="_blank" rel="noopener noreferrer" class="source-link">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                View Source
            </a>
        )}
        {technique.lastVerified && (
            <span class="verification-date">
                Last verified: {new Date(technique.lastVerified).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })}
            </span>
        )}
    </div>

    <!-- Hidden HowTo Schema for AI crawlers -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>HowTo: {technique.techniqueName}</h3>
        <p>Duration: {technique.totalDuration}</p>
        <p>Complexity: {technique.complexity}</p>
        <h4>Steps:</h4>
        {technique.steps.map(step => (
            <div>
                <p>Step {step.stepNumber}: {step.title}</p>
                <p>{step.description}</p>
            </div>
        ))}
        <h4>Instruments:</h4>
        <ul>
            {technique.instruments.map(inst => (
                <li>{inst.name}: {inst.purpose}</li>
            ))}
        </ul>
    </div>
</section>

<style>
    .technique-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .technique-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .header-main {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 0.5rem;
    }

    .technique-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.35rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .technique-title svg {
        color: var(--accent, #8b5cf6);
        opacity: 0.9;
    }

    .technique-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .complexity-badge {
        padding: 4px 12px;
        background: color-mix(in srgb, var(--badge-color) 15%, transparent);
        border: 1px solid color-mix(in srgb, var(--badge-color) 30%, transparent);
        border-radius: 100px;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--badge-color);
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .duration-badge, .year-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-muted, #888);
    }

    .technique-inventor {
        font-size: 0.9rem;
        color: var(--text-muted, #888);
        margin: 0;
    }

    .technique-inventor strong {
        color: var(--text-secondary, #ccc);
    }

    /* Summary Section */
    .summary-section {
        margin-bottom: 1.5rem;
    }

    .summary-toggle {
        display: flex;
        gap: 0.25rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 1rem;
    }

    .summary-tab {
        flex: 1;
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-muted, #888);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .summary-tab:hover {
        color: var(--text-secondary, #ccc);
    }

    .summary-tab--active {
        background: var(--accent, #8b5cf6);
        color: white;
    }

    .summary-panel {
        display: none;
    }

    .summary-panel--active {
        display: block;
    }

    .summary-panel p {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--text-secondary, #ccc);
        margin: 0;
    }

    /* Section Subtitle */
    .section-subtitle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
        margin: 0 0 1rem;
    }

    .section-subtitle svg {
        opacity: 0.7;
    }

    /* Instruments Grid */
    .instruments-section {
        margin-bottom: 1.5rem;
    }

    .instruments-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .instrument-card {
        display: flex;
        flex-direction: column;
        padding: 0.6rem 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 8px;
    }

    .instrument-card--specialized {
        background: rgba(139, 92, 246, 0.08);
        border-color: rgba(139, 92, 246, 0.2);
    }

    .instrument-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary, #fff);
    }

    .instrument-purpose {
        font-size: 0.75rem;
        color: var(--text-muted, #888);
    }

    .specialized-badge {
        margin-top: 0.25rem;
        font-size: 0.65rem;
        font-weight: 600;
        color: #a78bfa;
        text-transform: uppercase;
    }

    /* Steps Accordion */
    .steps-section {
        margin-bottom: 1.5rem;
    }

    .steps-accordion {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .step-item {
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 10px;
        overflow: hidden;
    }

    .step-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border: none;
        cursor: pointer;
        text-align: left;
        transition: background 0.2s ease;
    }

    .step-header:hover {
        background: rgba(255, 255, 255, 0.04);
    }

    .step-number {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent, #8b5cf6);
        border-radius: 50%;
        font-size: 0.85rem;
        font-weight: 700;
        color: white;
        flex-shrink: 0;
    }

    .step-header-content {
        flex: 1;
    }

    .step-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary, #fff);
        margin: 0;
    }

    .step-duration {
        font-size: 0.75rem;
        color: var(--text-muted, #888);
    }

    .step-chevron {
        color: var(--text-muted, #888);
        transition: transform 0.2s ease;
    }

    .step-header[aria-expanded="true"] .step-chevron {
        transform: rotate(180deg);
    }

    .step-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .step-content--open {
        max-height: 500px;
    }

    .step-content > * {
        padding: 0 1rem 1rem 3.5rem;
    }

    .step-description {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-secondary, #ccc);
        margin: 0 0 0.75rem;
        padding-top: 0.5rem;
    }

    .step-label {
        display: block;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
        margin-bottom: 0.35rem;
    }

    .step-label--warning {
        color: #f59e0b;
    }

    .step-instruments-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .mini-instrument {
        padding: 2px 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        font-size: 0.75rem;
        color: var(--text-secondary, #ccc);
    }

    .critical-list, .risks-list {
        margin: 0;
        padding-left: 1.2rem;
        font-size: 0.85rem;
        color: var(--text-secondary, #ccc);
    }

    .risks-list {
        color: #f59e0b;
    }

    .step-critical, .step-risks, .step-instruments {
        margin-bottom: 0.75rem;
    }

    /* Outcomes Section */
    .outcomes-section {
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: rgba(16, 185, 129, 0.05);
        border: 1px solid rgba(16, 185, 129, 0.15);
        border-radius: 12px;
    }

    .outcomes-grid {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .outcome-card {
        display: flex;
        flex-direction: column;
        padding: 1rem 1.5rem;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        text-align: center;
        min-width: 120px;
    }

    .outcome-card--success {
        background: rgba(16, 185, 129, 0.1);
    }

    .outcome-value {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: #10b981;
    }

    .outcome-card:not(.outcome-card--success) .outcome-value {
        color: var(--text-primary, #fff);
    }

    .outcome-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
        margin-top: 0.25rem;
    }

    .complications-section {
        padding-top: 1rem;
        border-top: 1px solid rgba(16, 185, 129, 0.15);
    }

    .complications-title {
        display: block;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
        margin-bottom: 0.5rem;
    }

    .complications-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .complication-tag {
        padding: 3px 10px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 100px;
        font-size: 0.75rem;
        color: #f87171;
    }

    /* Related Section */
    .related-section {
        margin-bottom: 1.5rem;
    }

    .related-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .related-tag {
        padding: 6px 14px;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.2);
        border-radius: 100px;
        font-size: 0.8rem;
        color: #a78bfa;
    }

    /* Footer */
    .technique-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .source-link {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        color: var(--accent, #8b5cf6);
        text-decoration: none;
    }

    .source-link:hover {
        text-decoration: underline;
    }

    .verification-date {
        font-size: 0.75rem;
        color: var(--text-muted, #888);
    }

    /* Tier colors */
    .tier-titan .step-number { background: linear-gradient(135deg, #ffd700, #f59e0b); }
    .tier-titan .technique-title svg { color: #ffd700; }
    .tier-elite .step-number { background: linear-gradient(135deg, #00aaff, #0070f3); }
    .tier-elite .technique-title svg { color: #00aaff; }
    .tier-master .step-number { background: linear-gradient(135deg, #00cc66, #10b981); }
    .tier-master .technique-title svg { color: #00cc66; }

    /* Responsive */
    @media (max-width: 640px) {
        .header-main {
            flex-direction: column;
            align-items: flex-start;
        }

        .technique-section {
            padding: 1.5rem;
        }

        .step-content > * {
            padding-left: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Summary toggle
        const summaryTabs = document.querySelectorAll('.summary-tab');
        summaryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = (tab as HTMLElement).dataset.target;

                // Update tabs
                summaryTabs.forEach(t => {
                    t.classList.remove('summary-tab--active');
                    t.setAttribute('aria-selected', 'false');
                });
                tab.classList.add('summary-tab--active');
                tab.setAttribute('aria-selected', 'true');

                // Update panels
                document.querySelectorAll('.summary-panel').forEach(panel => {
                    panel.classList.remove('summary-panel--active');
                });
                document.getElementById(target!)?.classList.add('summary-panel--active');
            });
        });

        // Steps accordion
        const stepHeaders = document.querySelectorAll('.step-header');
        stepHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const isExpanded = header.getAttribute('aria-expanded') === 'true';
                const content = header.nextElementSibling as HTMLElement;

                // Close all others
                stepHeaders.forEach(h => {
                    h.setAttribute('aria-expanded', 'false');
                    (h.nextElementSibling as HTMLElement)?.classList.remove('step-content--open');
                });

                // Toggle current
                if (!isExpanded) {
                    header.setAttribute('aria-expanded', 'true');
                    content?.classList.add('step-content--open');
                }
            });
        });
    });
</script>
