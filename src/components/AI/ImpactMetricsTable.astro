---
/**
 * ImpactMetricsTable - Time-series table showing impact metrics over years
 * Displays lives saved, procedures, citations with visual indicators
 */

import type { ImpactTimeSeriesData } from '../../lib/types';

interface Props {
    data: ImpactTimeSeriesData[];
    title?: string;
    tier?: string;
    doctorName?: string;
}

const { data, title = "Impact Over Time", tier = "UNRANKED", doctorName = "Physician" } = Astro.props;

// Sort by year descending
const sortedData = [...data].sort((a, b) => b.year - a.year);

// Calculate totals and find max values for scaling
const totals = data.reduce((acc, entry) => ({
    livesSaved: acc.livesSaved + (entry.livesSaved || 0),
    procedures: acc.procedures + (entry.proceduresPerformed || 0),
    citations: acc.citations + (entry.citationCount || 0),
    patients: acc.patients + (entry.patientsServed || 0),
    students: acc.students + (entry.studentsMentored || 0),
}), { livesSaved: 0, procedures: 0, citations: 0, patients: 0, students: 0 });

const maxValues = {
    livesSaved: Math.max(...data.map(d => d.livesSaved || 0)),
    procedures: Math.max(...data.map(d => d.proceduresPerformed || 0)),
    citations: Math.max(...data.map(d => d.citationCount || 0)),
    patients: Math.max(...data.map(d => d.patientsServed || 0)),
    students: Math.max(...data.map(d => d.studentsMentored || 0)),
};

// Determine which columns to show (only those with data)
const showLivesSaved = totals.livesSaved > 0;
const showProcedures = totals.procedures > 0;
const showCitations = totals.citations > 0;
const showPatients = totals.patients > 0;
const showStudents = totals.students > 0;

const yearRange = data.length > 0
    ? `${Math.min(...data.map(d => d.year))} - ${Math.max(...data.map(d => d.year))}`
    : '';
---

<section class={`impact-table-section tier-${tier.toLowerCase()}`}>
    <div class="impact-header">
        <h2 class="impact-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
            </svg>
            {title}
        </h2>
        {yearRange && <span class="year-range">{yearRange}</span>}
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        {showLivesSaved && (
            <div class="summary-card summary-card--lives">
                <span class="summary-value">{totals.livesSaved.toLocaleString()}</span>
                <span class="summary-label">Lives Saved</span>
            </div>
        )}
        {showProcedures && (
            <div class="summary-card">
                <span class="summary-value">{totals.procedures.toLocaleString()}</span>
                <span class="summary-label">Procedures</span>
            </div>
        )}
        {showCitations && (
            <div class="summary-card">
                <span class="summary-value">{totals.citations.toLocaleString()}</span>
                <span class="summary-label">Citations</span>
            </div>
        )}
        {showPatients && (
            <div class="summary-card">
                <span class="summary-value">{totals.patients.toLocaleString()}</span>
                <span class="summary-label">Patients</span>
            </div>
        )}
        {showStudents && (
            <div class="summary-card">
                <span class="summary-value">{totals.students.toLocaleString()}</span>
                <span class="summary-label">Mentored</span>
            </div>
        )}
    </div>

    <!-- Time Series Table -->
    <div class="table-wrapper">
        <table class="impact-table">
            <thead>
                <tr>
                    <th class="col-year">Year</th>
                    {showLivesSaved && <th class="col-data">Lives Saved</th>}
                    {showProcedures && <th class="col-data">Procedures</th>}
                    {showCitations && <th class="col-data">Citations</th>}
                    {showPatients && <th class="col-data">Patients</th>}
                    {showStudents && <th class="col-data">Mentored</th>}
                </tr>
            </thead>
            <tbody>
                {sortedData.map(entry => (
                    <tr>
                        <td class="col-year">
                            <span class="year-value">{entry.year}</span>
                        </td>
                        {showLivesSaved && (
                            <td class="col-data">
                                {entry.livesSaved ? (
                                    <div class="data-cell">
                                        <span class="data-value">{entry.livesSaved.toLocaleString()}</span>
                                        <div class="mini-bar">
                                            <div
                                                class="mini-bar-fill mini-bar-fill--lives"
                                                style={`width: ${(entry.livesSaved / maxValues.livesSaved) * 100}%`}
                                            ></div>
                                        </div>
                                    </div>
                                ) : (
                                    <span class="data-empty">-</span>
                                )}
                            </td>
                        )}
                        {showProcedures && (
                            <td class="col-data">
                                {entry.proceduresPerformed ? (
                                    <div class="data-cell">
                                        <span class="data-value">{entry.proceduresPerformed.toLocaleString()}</span>
                                        <div class="mini-bar">
                                            <div
                                                class="mini-bar-fill mini-bar-fill--procedures"
                                                style={`width: ${(entry.proceduresPerformed / maxValues.procedures) * 100}%`}
                                            ></div>
                                        </div>
                                    </div>
                                ) : (
                                    <span class="data-empty">-</span>
                                )}
                            </td>
                        )}
                        {showCitations && (
                            <td class="col-data">
                                {entry.citationCount ? (
                                    <div class="data-cell">
                                        <span class="data-value">{entry.citationCount.toLocaleString()}</span>
                                        <div class="mini-bar">
                                            <div
                                                class="mini-bar-fill mini-bar-fill--citations"
                                                style={`width: ${(entry.citationCount / maxValues.citations) * 100}%`}
                                            ></div>
                                        </div>
                                    </div>
                                ) : (
                                    <span class="data-empty">-</span>
                                )}
                            </td>
                        )}
                        {showPatients && (
                            <td class="col-data">
                                {entry.patientsServed ? (
                                    <div class="data-cell">
                                        <span class="data-value">{entry.patientsServed.toLocaleString()}</span>
                                        <div class="mini-bar">
                                            <div
                                                class="mini-bar-fill mini-bar-fill--patients"
                                                style={`width: ${(entry.patientsServed / maxValues.patients) * 100}%`}
                                            ></div>
                                        </div>
                                    </div>
                                ) : (
                                    <span class="data-empty">-</span>
                                )}
                            </td>
                        )}
                        {showStudents && (
                            <td class="col-data">
                                {entry.studentsMentored ? (
                                    <div class="data-cell">
                                        <span class="data-value">{entry.studentsMentored.toLocaleString()}</span>
                                        <div class="mini-bar">
                                            <div
                                                class="mini-bar-fill mini-bar-fill--students"
                                                style={`width: ${(entry.studentsMentored / maxValues.students) * 100}%`}
                                            ></div>
                                        </div>
                                    </div>
                                ) : (
                                    <span class="data-empty">-</span>
                                )}
                            </td>
                        )}
                    </tr>
                ))}
            </tbody>
            <tfoot>
                <tr class="totals-row">
                    <td class="col-year"><strong>Total</strong></td>
                    {showLivesSaved && <td class="col-data"><strong>{totals.livesSaved.toLocaleString()}</strong></td>}
                    {showProcedures && <td class="col-data"><strong>{totals.procedures.toLocaleString()}</strong></td>}
                    {showCitations && <td class="col-data"><strong>{totals.citations.toLocaleString()}</strong></td>}
                    {showPatients && <td class="col-data"><strong>{totals.patients.toLocaleString()}</strong></td>}
                    {showStudents && <td class="col-data"><strong>{totals.students.toLocaleString()}</strong></td>}
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Hidden semantic content for AI crawlers -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>Impact Dataset: {doctorName}</h3>
        <p>Time Coverage: {yearRange}</p>
        <table>
            <tr><th>Year</th><th>Lives Saved</th><th>Procedures</th><th>Citations</th></tr>
            {sortedData.map(entry => (
                <tr>
                    <td>{entry.year}</td>
                    <td>{entry.livesSaved || 0}</td>
                    <td>{entry.proceduresPerformed || 0}</td>
                    <td>{entry.citationCount || 0}</td>
                </tr>
            ))}
        </table>
    </div>
</section>

<style>
    .impact-table-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .impact-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .impact-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .impact-title svg {
        color: var(--accent, #8b5cf6);
        opacity: 0.8;
    }

    .year-range {
        font-size: 0.85rem;
        color: var(--text-muted, #888);
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 100px;
    }

    /* Summary Cards */
    .summary-cards {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
    }

    .summary-card {
        flex: 1;
        min-width: 100px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        text-align: center;
    }

    .summary-card--lives {
        background: rgba(16, 185, 129, 0.08);
        border-color: rgba(16, 185, 129, 0.2);
    }

    .summary-value {
        display: block;
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary, #fff);
    }

    .summary-card--lives .summary-value {
        color: #10b981;
    }

    .summary-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
    }

    /* Table */
    .table-wrapper {
        overflow-x: auto;
    }

    .impact-table {
        width: 100%;
        border-collapse: collapse;
    }

    .impact-table th,
    .impact-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .impact-table th {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted, #888);
    }

    .col-year {
        width: 80px;
    }

    .year-value {
        font-family: var(--font-mono);
        font-weight: 600;
        color: var(--text-primary, #fff);
    }

    .data-cell {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .data-value {
        font-family: var(--font-mono);
        font-size: 0.9rem;
        color: var(--text-secondary, #ccc);
    }

    .data-empty {
        color: var(--text-muted, #888);
    }

    /* Mini sparkline bars */
    .mini-bar {
        width: 100%;
        max-width: 80px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .mini-bar-fill {
        height: 100%;
        border-radius: 2px;
        transition: width 0.5s ease;
    }

    .mini-bar-fill--lives { background: #10b981; }
    .mini-bar-fill--procedures { background: #3b82f6; }
    .mini-bar-fill--citations { background: #8b5cf6; }
    .mini-bar-fill--patients { background: #f59e0b; }
    .mini-bar-fill--students { background: #ec4899; }

    .totals-row {
        background: rgba(255, 255, 255, 0.03);
    }

    .totals-row td {
        border-bottom: none;
        color: var(--text-primary, #fff);
    }

    /* Tier colors */
    .tier-titan .impact-title svg { color: #ffd700; }
    .tier-elite .impact-title svg { color: #00aaff; }
    .tier-master .impact-title svg { color: #00cc66; }

    /* Responsive */
    @media (max-width: 640px) {
        .impact-table-section {
            padding: 1.5rem;
        }

        .summary-cards {
            flex-wrap: wrap;
        }

        .summary-card {
            min-width: calc(50% - 0.5rem);
        }

        .impact-table th,
        .impact-table td {
            padding: 0.6rem 0.75rem;
        }
    }
</style>
