---
/**
 * FailureAnalysis - Superseded Procedures & Lessons Learned
 * Documents what was learned from procedures that didn't work
 */

import type { FailureAnalysis } from '../../lib/ai-content-types';

interface Props {
    analyses: FailureAnalysis[];
    doctorName: string;
    tier?: string;
}

const { analyses, doctorName, tier = 'UNRANKED' } = Astro.props;

// Reason configuration
const reasonConfig: Record<FailureAnalysis['reasonForFailure'], { label: string; icon: string; color: string }> = {
    SAFETY_CONCERNS: { label: 'Safety Concerns', icon: '‚ö†Ô∏è', color: '#ef4444' },
    BETTER_ALTERNATIVE: { label: 'Better Alternative Found', icon: 'üîÑ', color: '#10b981' },
    LIMITED_EFFICACY: { label: 'Limited Efficacy', icon: 'üìâ', color: '#f59e0b' },
    COMPLICATIONS: { label: 'Complication Rate', icon: 'üè•', color: '#f97316' },
    TECHNOLOGICAL_ADVANCEMENT: { label: 'Technology Evolved', icon: 'üöÄ', color: '#3b82f6' },
    COST_PROHIBITIVE: { label: 'Cost Prohibitive', icon: 'üí∞', color: '#8b5cf6' },
};
---

<section class={`failure-analysis-section tier-${tier.toLowerCase()}`}>
    <div class="section-header">
        <h2 class="section-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
            Learning from Experience
        </h2>
        <span class="section-subtitle">Superseded procedures and scientific contributions</span>
    </div>

    <div class="analysis-intro">
        <p>
            Medical progress comes from understanding what works‚Äîand what doesn't.
            These procedures, while eventually superseded, contributed valuable insights to the field.
        </p>
    </div>

    <div class="analyses-list">
        {analyses.map((analysis, index) => (
            <article class="analysis-card">
                <div class="card-header">
                    <div class="procedure-info">
                        <h3 class="procedure-name">{analysis.procedureName}</h3>
                        {(analysis.yearIntroduced || analysis.yearSuperseded) && (
                            <span class="year-range">
                                {analysis.yearIntroduced && `Introduced: ${analysis.yearIntroduced}`}
                                {analysis.yearIntroduced && analysis.yearSuperseded && ' ‚Ä¢ '}
                                {analysis.yearSuperseded && `Superseded: ${analysis.yearSuperseded}`}
                            </span>
                        )}
                    </div>
                    <span
                        class="reason-badge"
                        style={`--reason-color: ${reasonConfig[analysis.reasonForFailure].color};`}
                    >
                        <span class="reason-icon">{reasonConfig[analysis.reasonForFailure].icon}</span>
                        {reasonConfig[analysis.reasonForFailure].label}
                    </span>
                </div>

                <div class="card-body">
                    <div class="info-section">
                        <h4 class="info-label">Original Rationale</h4>
                        <p class="info-text">{analysis.originalRationale}</p>
                    </div>

                    {analysis.lessonsLearned.length > 0 && (
                        <div class="info-section lessons">
                            <h4 class="info-label">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                Lessons Learned
                            </h4>
                            <ul class="lessons-list">
                                {analysis.lessonsLearned.map(lesson => (
                                    <li>{lesson}</li>
                                ))}
                            </ul>
                        </div>
                    )}

                    <div class="contribution-section">
                        <h4 class="info-label">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Scientific Contribution
                        </h4>
                        <p class="contribution-text">{analysis.scientificContribution}</p>
                    </div>

                    {analysis.successorProcedure && (
                        <div class="successor-section">
                            <span class="successor-label">Successor:</span>
                            <span class="successor-name">{analysis.successorProcedure}</span>
                        </div>
                    )}

                    {analysis.patientOutcomes && (
                        <div class="outcomes-section">
                            <span class="outcomes-label">Patient Outcomes:</span>
                            <span class="outcomes-text">{analysis.patientOutcomes}</span>
                        </div>
                    )}

                    {analysis.references && analysis.references.length > 0 && (
                        <div class="references-section">
                            <span class="references-label">References:</span>
                            <div class="references-list">
                                {analysis.references.slice(0, 3).map(ref => (
                                    <a
                                        href={ref.url || (ref.type === 'DOI' ? `https://doi.org/${ref.identifier}` : ref.type === 'PUBMED' ? `https://pubmed.ncbi.nlm.nih.gov/${ref.identifier}` : '#')}
                                        target="_blank"
                                        rel="noopener"
                                        class="reference-link"
                                    >
                                        {ref.type}
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            </article>
        ))}
    </div>

    <!-- Hidden semantic layer for AI -->
    <div class="ai-semantic-layer" aria-hidden="true" style="display:none;">
        <h3>Failure Analysis and Learning History for {doctorName}</h3>
        {analyses.map(a => (
            <article>
                <h4>{a.procedureName}</h4>
                <p>Introduced: {a.yearIntroduced}, Superseded: {a.yearSuperseded}</p>
                <p>Original rationale: {a.originalRationale}</p>
                <p>Reason for discontinuation: {a.reasonForFailure}</p>
                <p>Lessons learned: {a.lessonsLearned.join('; ')}</p>
                <p>Scientific contribution: {a.scientificContribution}</p>
                {a.successorProcedure && <p>Replaced by: {a.successorProcedure}</p>}
            </article>
        ))}
    </div>
</section>

<style>
    .failure-analysis-section {
        background: var(--card-bg, rgba(20, 20, 35, 0.8));
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(10px);
    }

    .section-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .section-title svg {
        color: #f59e0b;
        opacity: 0.9;
    }

    .section-subtitle {
        font-size: 0.85rem;
        color: var(--text-muted, #888);
    }

    .analysis-intro {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(245, 158, 11, 0.05);
        border: 1px solid rgba(245, 158, 11, 0.1);
        border-radius: 10px;
    }

    .analysis-intro p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.6;
    }

    .analyses-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .analysis-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--card-border, rgba(255, 255, 255, 0.06));
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .analysis-card:hover {
        border-color: rgba(255, 255, 255, 0.1);
    }

    .card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        padding: 1.25rem;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }

    .procedure-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .procedure-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
        color: var(--text-primary, #fff);
    }

    .year-range {
        font-size: 0.75rem;
        color: var(--text-muted, #888);
    }

    .reason-badge {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        padding: 4px 10px;
        background: color-mix(in srgb, var(--reason-color) 15%, transparent);
        border-radius: 100px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--reason-color);
        white-space: nowrap;
    }

    .reason-icon {
        font-size: 0.85rem;
    }

    .card-body {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .info-section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-muted, #888);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
    }

    .info-label svg {
        color: #f59e0b;
    }

    .info-text {
        font-size: 0.9rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.6;
        margin: 0;
    }

    /* Lessons Section */
    .info-section.lessons {
        padding: 1rem;
        background: rgba(16, 185, 129, 0.05);
        border: 1px solid rgba(16, 185, 129, 0.1);
        border-radius: 8px;
    }

    .lessons-list {
        margin: 0;
        padding-left: 1.25rem;
    }

    .lessons-list li {
        font-size: 0.875rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.6;
        margin-bottom: 0.35rem;
    }

    .lessons-list li::marker {
        color: #10b981;
    }

    /* Contribution Section */
    .contribution-section {
        padding: 1rem;
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: 8px;
    }

    .contribution-text {
        font-size: 0.9rem;
        color: var(--text-secondary, #ccc);
        line-height: 1.6;
        margin: 0;
    }

    /* Successor */
    .successor-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .successor-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .successor-name {
        font-size: 0.875rem;
        color: #10b981;
        font-weight: 500;
    }

    /* Outcomes */
    .outcomes-section {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .outcomes-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
        flex-shrink: 0;
    }

    .outcomes-text {
        font-size: 0.875rem;
        color: var(--text-secondary, #ccc);
    }

    /* References */
    .references-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .references-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted, #888);
    }

    .references-list {
        display: flex;
        gap: 0.35rem;
    }

    .reference-link {
        padding: 2px 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-secondary, #ccc);
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .reference-link:hover {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
    }

    /* Tier colors */
    .tier-titan .section-title svg { color: #ffd700; }
    .tier-elite .section-title svg { color: #00aaff; }
    .tier-master .section-title svg { color: #00cc66; }

    @media (max-width: 768px) {
        .failure-analysis-section {
            padding: 1.5rem;
        }

        .card-header {
            flex-direction: column;
            gap: 0.75rem;
        }

        .reason-badge {
            align-self: flex-start;
        }
    }
</style>
